# 提成计算系统实施总结

## 已完成的分析

### 1. 三级分配体系已明确

#### 第一级：项目提成总额计算
**输入因子：**
- 建筑类型（办公、住宅、学校、商业、工业、其他）
- 设计阶段（方案、施工图、施工配合）
- 建筑面积（平方米）
- 特殊属性（地下室、人防、绿建、装配式、报建、审图）

**计算公式：**
```
项目提成总额 = 建筑面积 × 基础单价 × 阶段系数 × (1 + 特殊属性加成)
```

**配置文件：** `server/config/commission-config.json` - level1部分

#### 第二级：部门分配计算
**输入因子：**
- 项目提成总额（来自第一级）
- 空调面积表（各种空调类型及对应面积）

**空调类型：**
- 没有空调
- 全中央空调
- VRV空调（布管）
- VRV空调（不布管）
- 分体空调及消防排烟
- 仅有分体空调
- 仅有消防排烟
- 地下室通风及消防排烟

**参与部门：**
- 总负责、创作部、建筑一部、建筑二部、建筑三部、结构部、给排水部、电气部、空调部

**计算逻辑：**
```
1. 计算每种空调类型的面积占比
2. 根据空调类型和面积占比，计算各部门的加权系数
3. 部门分配金额 = (部门加权系数 / 总加权系数) × 项目提成总额
```

**配置文件：** `server/config/commission-config.json` - level2部分

#### 第三级：部门内分配
**特点：**
- 由部门经理手动分配
- 无需计算公式
- 系统验证：部门内分配总额 ≤ 部门可分配总额

---

## 已实现的功能

### 1. 配置化计算系统
- ✅ 创建了配置文件 `commission-config.json`
- ✅ 所有计算系数都可配置
- ✅ 支持灵活调整参数

### 2. 计算工具函数
文件：`server/utils/commission.js`

- ✅ `calculateTotalCommission()` - 第一级计算
- ✅ `calculateDepartmentAllocation()` - 第二级计算
- ✅ `calculateAdditionCommission()` - 追加计算
- ✅ `getConfig()` - 获取配置

### 3. 数据库结构
文件：`server/db/init.js`

- ✅ 项目表增加了建筑属性字段
- ✅ 支持存储所有必要的计算因子

---

## 下一步工作

### 需要完成的任务

1. **更新项目API**
   - 修改项目创建/更新API，支持新的属性字段
   - 集成新的计算逻辑

2. **实现空调面积表管理**
   - 创建空调面积表的CRUD API
   - 关联到项目

3. **实现部门分配功能**
   - 基于空调面积表计算部门分配
   - 显示计算明细

4. **实现部门内分配功能**
   - 部门经理分配界面
   - 分配验证逻辑

5. **更新测试**
   - 更新现有测试以适应新的计算逻辑
   - 添加配置化计算的测试

6. **创建前端界面**
   - 项目管理界面（包含属性选择）
   - 空调面积表录入界面
   - 提成计算和分配界面

---

## 配置说明

### 如何调整计算参数

编辑 `server/config/commission-config.json`：

**调整建筑类型单价：**
```json
"buildingTypes": {
  "office": {
    "name": "办公楼",
    "baseRate": 5.0  ← 修改这里（元/㎡）
  }
}
```

**调整设计阶段系数：**
```json
"designStages": {
  "scheme": {
    "name": "方案设计",
    "coefficient": 0.6  ← 修改这里（相对于施工图）
  }
}
```

**调整特殊属性加成：**
```json
"specialAttributes": {
  "hasBasement": {
    "name": "有地下室",
    "bonus": 0.15  ← 修改这里（增加15%）
  }
}
```

**调整部门分配系数：**
```json
"airConditioningTypes": {
  "centralAC": {
    "name": "全中央空调",
    "coefficients": {
      "chief": 0.05,
      "arch1": 0.30,  ← 修改各部门系数
      "hvac": 0.50
    }
  }
}
```

---

## 注意事项

1. **配置文件修改后需要重启服务器**
2. **所有系数都是相对值，会自动归一化**
3. **建议保留配置文件的历史版本**
4. **重大调整前应该备份数据库**
5. **可以为不同时期使用不同的配置版本**
