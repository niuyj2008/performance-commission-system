# 部门经理第一级权限限制

## 需求描述
第一级（项目总提成）的内容只有总经理或财务可以看到，对部门经理不开放。

## 实现方案
修改 `displayLevel1` 函数，根据用户角色显示不同的内容。

### 修改文件
`public/project-detail.html`

### 修改内容

在 `displayLevel1` 函数开始处添加角色判断：

```javascript
function displayLevel1(data) {
  const content = document.getElementById('level1Content');
  
  // 如果是部门经理，不显示项目总提成详情
  if (currentUserInfo && currentUserInfo.role === 'manager') {
    content.innerHTML = `
      <div class="empty-state">
        <div style="font-size: 48px; margin-bottom: 10px;">🔒</div>
        <div style="font-size: 16px; color: #666;">项目总提成信息仅对管理员和财务开放</div>
        <div style="font-size: 14px; color: #999; margin-top: 10px;">您可以在下方查看本部门的分配情况</div>
      </div>
    `;
    return;
  }
  
  // 管理员和财务查看完整信息
  // ... 原有代码
}
```

## 显示效果

### 部门经理视图
```
┌─────────────────────────────────────────┐
│ 第一级：项目总提成                       │
│                                         │
│              🔒                          │
│                                         │
│   项目总提成信息仅对管理员和财务开放      │
│   您可以在下方查看本部门的分配情况        │
│                                         │
└─────────────────────────────────────────┘
```

### 管理员/财务视图
```
┌─────────────────────────────────────────┐
│ 第一级：项目总提成                       │
│                                         │
│ 总提成：¥230,902                        │
│                                         │
│ 计算公式：建筑面积 × 设计费单价 × ...    │
│                                         │
│ ┌──────────┐ ┌──────────┐ ┌──────────┐ │
│ │建筑面积   │ │设计费单价 │ │提成比例   │ │
│ │35,287㎡  │ │¥6.54/㎡  │ │15.0%     │ │
│ └──────────┘ └──────────┘ └──────────┘ │
│ ... (更多明细)                          │
└─────────────────────────────────────────┘
```

## 三级权限矩阵

| 级别 | 内容 | 管理员 | 财务 | 部门经理 | 普通员工 |
|------|------|--------|------|----------|----------|
| 第一级 | 项目总提成 | ✅ 完整信息 | ✅ 完整信息 | 🔒 受限提示 | ❌ 无权访问 |
| 第二级 | 部门分配 | ✅ 所有部门 | ✅ 所有部门 | ✅ 仅本部门 | ❌ 无权访问 |
| 第三级 | 个人分配 | ✅ 所有部门 | ✅ 所有部门 | ✅ 仅本部门 | ❌ 无权访问 |

## 权限设计理由

### 为什么隐藏第一级？
1. **商业机密**: 项目总提成金额是公司的商业机密
2. **避免攀比**: 防止部门之间因总额产生不必要的攀比
3. **专注本职**: 部门经理只需关注本部门的分配和管理
4. **分级管理**: 符合企业分级管理的原则

### 为什么开放第二级和第三级？
1. **工作需要**: 部门经理需要知道本部门的分配额度
2. **人员管理**: 需要根据部门总额进行个人分配
3. **数据隔离**: 只能看到本部门数据，不会泄露其他部门信息
4. **责任明确**: 部门经理对本部门的分配负责

## 用户体验设计

### 友好的提示信息
- 使用🔒图标表示权限限制
- 清晰说明原因："仅对管理员和财务开放"
- 提供引导："您可以在下方查看本部门的分配情况"
- 避免使用"拒绝访问"等负面词汇

### 视觉设计
- 使用 `empty-state` 样式，保持界面一致性
- 灰色文字，不过分突出限制信息
- 保持页面结构完整，不影响下方内容的查看

## 测试步骤

### 1. 测试部门经理视图
```
1. 使用建筑部经理登录: manager_arch / manager123
2. 进入项目详情页
3. 确认第一级显示权限限制提示
4. 确认第二级显示本部门分配
5. 确认第三级可以进行个人分配
```

### 2. 测试管理员视图
```
1. 使用管理员登录: admin / admin123
2. 进入项目详情页
3. 确认第一级显示完整的项目总提成信息
4. 确认第二级显示所有部门分配
5. 确认第三级显示所有部门的个人分配
```

### 3. 测试财务视图
```
1. 使用财务登录: finance / finance123
2. 进入项目详情页
3. 确认第一级显示完整信息
4. 确认第二级显示所有部门分配
5. 确认第三级显示所有部门的个人分配
```

### 4. 测试不同部门经理
```
1. 使用结构部经理登录: manager_struct / manager123
2. 确认第一级显示权限限制
3. 确认第二级只显示结构部的分配
4. 确认第三级只能管理结构部的个人分配
```

## 完整的部门经理工作流程

1. **登录系统**
   - 使用部门经理账号登录

2. **查看项目列表**
   - 进入项目管理界面
   - 查看所有项目（可以看到项目名称、编号等基本信息）

3. **进入项目详情**
   - 点击"查看详情"按钮
   - 看到三级提成结构

4. **第一级：受限访问**
   - 显示权限限制提示
   - 无法查看项目总提成金额

5. **第二级：查看本部门分配**
   - 查看本部门的分配金额
   - 查看分配比例
   - 了解工种奖金总额（不含总负责）

6. **第三级：管理个人分配**
   - 点击"分配参与人员"
   - 为本部门员工分配提成
   - 确保总额不超过部门限额

7. **员工管理**
   - 管理本部门员工信息
   - 查看员工列表

## 安全考虑

### 前端限制
- ✅ 在 `displayLevel1` 中检查用户角色
- ✅ 部门经理看不到总提成金额
- ✅ 部门经理看不到计算公式和明细

### 后端保护
- ✅ API仍然需要认证
- ✅ 计算API对所有认证用户开放（只读操作）
- ✅ 修改操作仍然受权限保护

### 数据隔离
- ✅ 第二级：部门经理只看本部门
- ✅ 第三级：部门经理只管理本部门员工
- ✅ 员工管理：部门经理只看本部门员工

## 相关文件
- `public/project-detail.html` - 项目详情页面
- `server/routes/commission.js` - 提成计算API
- `server/routes/air-conditioning.js` - 部门分配API

## 注意事项

1. **用户信息加载**: 必须在 `loadProjectDetail()` 开始时加载 `currentUserInfo`
2. **角色判断**: 使用 `currentUserInfo.role === 'manager'` 判断
3. **友好提示**: 使用积极的语言，避免让用户感到被拒绝
4. **保持一致**: 三级的权限控制逻辑保持一致

## 未来增强

### 可选功能
1. **部门总额提示**: 在第一级显示"您的部门分配：¥XX"
2. **进度指示**: 显示本部门的分配进度
3. **历史对比**: 显示本部门在不同项目中的分配情况

### 审计功能
1. 记录谁尝试访问了第一级信息
2. 记录部门经理的查看行为
3. 生成访问报告

---

**修复日期**: 2024年12月14日
**修复人员**: Kiro AI Assistant
