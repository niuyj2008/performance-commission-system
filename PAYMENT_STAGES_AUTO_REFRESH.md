# 发放节点自动刷新功能

## 功能说明
当发放节点规划数据有变化更新时，系统会自动刷新第二级"部门分配"界面中的全部数据，确保显示的当期金额与最新的发放节点配置保持一致。

## 实现细节

### 1. 保存发放节点后自动刷新
当用户在第一级保存发放节点配置后，系统会：
1. 保存发放节点数据到数据库
2. 重新加载发放节点列表
3. **自动刷新第二级部门分配界面**
4. 显示成功提示消息

**代码位置：** `public/project-detail.html` - `savePaymentStages()` 函数

```javascript
async function savePaymentStages() {
  // ... 验证和保存逻辑 ...
  
  alert('发放节点保存成功！');
  closePaymentStagesModal();
  
  // 重新加载发放节点数据
  await loadPaymentStages();
  
  // 自动刷新第二级部门分配界面
  await loadLevel2();
  
  // 提示用户数据已更新
  showMessage('发放节点已更新，第二级部门分配已刷新', 'success');
}
```

### 2. 切换发放节点时自动刷新
当用户在第二级使用发放节点选择器切换不同节点时，系统会：
1. 更新全局变量 `selectedPaymentStage`
2. **自动重新加载第二级部门分配界面**
3. 根据新选择的节点重新计算当期金额

**代码位置：** `public/project-detail.html` - `onPaymentStageChange()` 函数

```javascript
function onPaymentStageChange() {
  const selector = document.getElementById('paymentStageSelector');
  if (selector) {
    const index = parseInt(selector.value);
    selectedPaymentStage = paymentStages[index];
    // 重新加载第二级显示
    loadLevel2();
  }
}
```

## 刷新流程

### 流程图
```
用户操作
  ↓
保存发放节点 / 切换发放节点
  ↓
更新 selectedPaymentStage
  ↓
调用 loadLevel2()
  ↓
重新获取部门分配数据
  ↓
调用 displayLevel2(data)
  ↓
重新计算当期金额 = 总额 × current_ratio
  ↓
更新界面显示
```

### 详细步骤

1. **获取部门分配数据**
   - 调用 `/api/air-conditioning/:projectId/calculate-allocation`
   - 获取各部门的总分配金额

2. **计算当期金额**
   - 获取当前选择的发放节点的 `current_ratio`
   - 计算：`当期金额 = 部门总额 × current_ratio`

3. **更新界面显示**
   - 管理员/财务：显示所有部门的总额和当期金额
   - 部门经理：显示本部门的总额和当期金额

## 测试步骤

### 测试场景1：保存新的发放节点
1. 使用管理员账号登录（admin / admin123）
2. 进入项目详情页面
3. 在第一级点击"配置发放节点"
4. 添加一个新阶段：
   - 日期：202002
   - 阶段：方案设计
   - 本期比例：25
5. 点击"保存"
6. **验证：**
   - 看到"发放节点保存成功！"提示
   - 看到"发放节点已更新，第二级部门分配已刷新"消息
   - 第二级部门分配界面自动刷新
   - 发放节点选择器中出现新添加的节点
   - 各部门的当期金额根据新节点重新计算

### 测试场景2：修改现有发放节点
1. 使用管理员账号登录
2. 进入项目详情页面
3. 在第一级点击"配置发放节点"
4. 修改某个阶段的本期比例（如从75%改为80%）
5. 点击"保存"
6. **验证：**
   - 第二级部门分配界面自动刷新
   - 各部门的当期金额根据新比例重新计算
   - 例如：部门总额 ¥100,000
     - 修改前（75%）：当期金额 ¥75,000
     - 修改后（80%）：当期金额 ¥80,000

### 测试场景3：切换发放节点
1. 使用管理员账号登录
2. 进入项目详情页面
3. 确保已配置多个发放节点
4. 在第二级使用发放节点选择器
5. 切换到不同的发放节点
6. **验证：**
   - 第二级部门分配界面立即刷新
   - 各部门的当期金额根据选择的节点重新计算
   - 例如：部门总额 ¥100,000
     - 节点1（75%）：当期金额 ¥75,000
     - 节点2（20%）：当期金额 ¥20,000
     - 节点3（5%）：当期金额 ¥5,000

### 测试场景4：部门经理视图
1. 使用部门经理账号登录（manager_arch / manager123）
2. 进入项目详情页面
3. 查看第二级部门分配
4. **验证：**
   - 只显示本部门的分配信息
   - 显示总额和当期金额
   - 不显示发放节点选择器（因为部门经理没有权限修改）
   - 当管理员修改发放节点后，刷新页面可以看到更新后的当期金额

## 数据一致性保证

### 1. 实时计算
- 当期金额始终基于最新的发放节点数据实时计算
- 公式：`当期金额 = 部门总额 × selectedPaymentStage.current_ratio`

### 2. 自动同步
- 保存发放节点后立即刷新第二级
- 切换发放节点后立即刷新第二级
- 确保界面显示与数据库数据保持一致

### 3. 级联更新
- 第一级：配置发放节点
- 第二级：自动更新当期金额
- 第三级：基于第二级的当期金额进行限额验证

## 用户体验优化

### 1. 即时反馈
- 保存成功后立即显示更新结果
- 无需手动刷新页面
- 提供明确的成功提示消息

### 2. 平滑过渡
- 界面刷新过程流畅
- 保持用户当前的浏览位置
- 不会导致页面跳动

### 3. 错误处理
- 如果刷新失败，显示错误提示
- 不影响发放节点的保存操作
- 用户可以手动刷新页面

## 技术实现

### 关键函数

1. **savePaymentStages()**
   - 保存发放节点
   - 调用 `loadPaymentStages()` 重新加载节点列表
   - 调用 `loadLevel2()` 刷新第二级界面

2. **onPaymentStageChange()**
   - 处理发放节点选择器变化
   - 更新 `selectedPaymentStage` 变量
   - 调用 `loadLevel2()` 刷新第二级界面

3. **loadLevel2()**
   - 获取部门分配数据
   - 调用 `displayLevel2(data)` 显示界面

4. **displayLevel2(data)**
   - 根据 `selectedPaymentStage.current_ratio` 计算当期金额
   - 渲染部门分配界面
   - 显示总额和当期金额

### 全局变量

```javascript
// 当前选择的发放节点
let selectedPaymentStage = null;

// 所有发放节点列表
let paymentStages = [];
```

## 相关文件
- `public/project-detail.html` - 前端实现
- `server/routes/payment-stages.js` - 发放节点API
- `PAYMENT_STAGES_COMPLETE_IMPLEMENTATION.md` - 完整实现文档

## 注意事项

1. **权限控制**
   - 只有管理员和财务可以修改发放节点
   - 部门经理只能查看，不能修改

2. **数据验证**
   - 保存前验证总比例不超过100%
   - 确保所有必填字段都已填写

3. **性能考虑**
   - 刷新操作是异步的，不会阻塞用户界面
   - 使用 `await` 确保操作按顺序执行

4. **兼容性**
   - 支持所有现代浏览器
   - 使用标准的 Fetch API

## 总结

发放节点自动刷新功能确保了：
- ✅ 数据实时同步
- ✅ 用户体验流畅
- ✅ 界面显示准确
- ✅ 操作简单直观

用户无需手动刷新页面，系统会自动更新第二级部门分配界面，显示最新的当期金额。
