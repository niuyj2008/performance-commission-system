# 项目创建时配置空调面积表功能说明

## 更新日期
2024年12月14日

## 功能概述

现在在创建或编辑项目时，可以直接在同一个表单中配置空调面积表，无需在创建项目后再单独配置。

## 功能位置

**项目管理** → **创建项目** / **编辑项目** → **空调面积表**

## 主要改进

### 之前的流程
1. 创建项目（填写基本信息）
2. 保存项目
3. 进入项目详情页
4. 点击"配置空调面积表"
5. 配置空调面积表

### 现在的流程
1. 创建项目（填写基本信息 + 配置空调面积表）
2. 保存项目（同时保存空调面积表）

**优势**: 一次性完成所有配置，提高效率

## 功能特性

### 1. 集成在项目表单中

空调面积表配置区域直接集成在项目创建/编辑表单中，位于"项目属性"之后。

### 2. 实时编辑

- **添加记录**: 点击"+ 添加"按钮
- **编辑数据**: 直接在表格中修改
- **删除记录**: 点击每行的"删除"按钮

### 3. 表格字段

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 序号 | 自动 | - | 自动生成 |
| 空调形式 | 下拉选择 | ✓ | 8种空调类型 |
| 采用空调部位 | 文本 | - | 例如：1#产业用房1~2F |
| 空调面积（㎡） | 数字 | ✓ | 必须大于0 |
| 备注 | 文本 | - | 其他说明 |
| 操作 | 按钮 | - | 删除按钮 |

### 4. 支持的空调类型

1. 没有空调
2. 全中央空调
3. VRV空调（布管）
4. VRV空调（不布管）
5. 分体空调及消防排烟
6. 仅有分体空调
7. 仅有消防排烟
8. 地下室通风及消防排烟

### 5. 数据验证

系统在保存时会验证：
- 空调形式必须选择
- 空调面积必须大于0
- 所有必填字段都已填写

如果验证失败，会提示具体的错误信息，不会保存项目。

## 使用流程

### 创建新项目

1. 点击"创建项目"按钮
2. 填写项目基本信息：
   - 项目编号 *
   - 项目名称 *
   - 设计阶段
   - 建筑类型
   - 建筑面积
   - 期间
   - 项目属性（勾选框）
3. 配置空调面积表：
   - 点击"+ 添加"按钮
   - 选择空调形式
   - 填写采用空调部位（可选）
   - 输入空调面积
   - 填写备注（可选）
   - 可以添加多条记录
4. 点击"保存"按钮
5. 系统自动保存项目和空调面积表

### 编辑现有项目

1. 在项目列表中找到要编辑的项目
2. 点击"编辑"按钮
3. 系统自动加载项目信息和空调面积表
4. 修改项目信息或空调面积表
5. 点击"保存"按钮
6. 系统更新项目和空调面积表

## 技术实现

### 前端实现

#### 数据管理
```javascript
let acTableData = []; // 存储空调面积表数据

// 空调类型选项
const acTypes = [
  '没有空调',
  '全中央空调',
  'VRV空调（布管）',
  'VRV空调（不布管）',
  '分体空调及消防排烟',
  '仅有分体空调',
  '仅有消防排烟',
  '地下室通风及消防排烟'
];
```

#### 核心函数
- `renderAcTable()` - 渲染空调面积表
- `addAcRow()` - 添加新行
- `deleteAcRow(index)` - 删除指定行
- `showAddModal()` - 打开创建模态框（清空空调面积表）
- `editProject(id)` - 打开编辑模态框（加载空调面积表）

#### 表单提交流程
1. 验证项目基本信息
2. 验证空调面积表数据
3. 保存项目到服务器
4. 获取项目ID
5. 保存空调面积表到服务器
6. 显示成功消息
7. 刷新项目列表

### 后端API

#### 保存空调面积表
```
POST /api/air-conditioning/:projectId
Body: {
  "tables": [
    {
      "ac_type": "全中央空调",
      "location": "2#数据中心",
      "area": 23215,
      "notes": "含机械排烟、新风等"
    },
    ...
  ]
}
```

#### 获取空调面积表
```
GET /api/air-conditioning/:projectId
Response: {
  "tables": [...]
}
```

## 界面设计

### 模态框尺寸
- 最大宽度: 1200px（从800px增加）
- 宽度: 95%（从90%增加）
- 最大高度: 90vh
- 支持垂直滚动

### 空调面积表区域
- 位置: 项目属性之后
- 标题: "空调面积表"
- 操作按钮: "+ 添加"（右上角）
- 表格样式: 
  - 固定表头
  - 最大高度: 300px
  - 支持垂直滚动
  - 边框: 1px solid #e8e8e8

### 表格样式
- 表头: 浅灰色背景 (#fafafa)
- 行间距: 适中
- 输入框: 内嵌在单元格中
- 删除按钮: 红色，小尺寸

## 数据流程

### 创建项目
```
用户填写表单
  ↓
验证数据
  ↓
POST /api/projects
  ↓
获取项目ID
  ↓
POST /api/air-conditioning/:projectId
  ↓
显示成功消息
  ↓
刷新列表
```

### 编辑项目
```
点击编辑按钮
  ↓
GET /api/projects/:id
  ↓
GET /api/air-conditioning/:id
  ↓
填充表单
  ↓
用户修改数据
  ↓
验证数据
  ↓
PUT /api/projects/:id
  ↓
POST /api/air-conditioning/:id
  ↓
显示成功消息
  ↓
刷新列表
```

## 示例数据

### 示例1：办公建筑项目

**项目信息**:
- 项目编号: 2025-001
- 项目名称: 华韶数码城
- 设计阶段: 施工图设计
- 建筑类型: 办公建筑
- 建筑面积: 35287㎡
- 期间: 2025年上半年

**空调面积表**:
| 序号 | 空调形式 | 采用空调部位 | 空调面积 | 备注 |
|------|----------|--------------|----------|------|
| 1 | 全中央空调 | 2#数据中心 | 23215㎡ | 含机械排烟、新风等 |
| 2 | VRV空调（布管） | 1#产业用房1~2F | 1795㎡ | - |
| 3 | VRV空调（不布管） | 1#产业用房3~12F | 10277㎡ | - |

### 示例2：住宅建筑项目

**项目信息**:
- 项目编号: 2025-002
- 项目名称: 阳光花园
- 设计阶段: 施工图设计
- 建筑类型: 住宅建筑
- 建筑面积: 50000㎡
- 期间: 2025年上半年

**空调面积表**:
| 序号 | 空调形式 | 采用空调部位 | 空调面积 | 备注 |
|------|----------|--------------|----------|------|
| 1 | 分体空调及消防排烟 | 住宅楼 | 45000㎡ | 高层住宅 |
| 2 | 地下室通风及消防排烟 | 地下车库 | 5000㎡ | - |

## 注意事项

1. **必填字段**: 空调形式和空调面积是必填的
2. **数据验证**: 保存前会验证所有数据
3. **空表格**: 可以不添加任何空调面积记录（适用于没有空调的项目）
4. **编辑加载**: 编辑项目时会自动加载现有的空调面积表
5. **数据覆盖**: 保存时会覆盖该项目的所有空调面积表数据
6. **权限要求**: 只有管理员和财务人员可以创建/编辑项目

## 优势总结

✅ **一次性配置**: 创建项目时同时配置空调面积表  
✅ **提高效率**: 减少操作步骤，节省时间  
✅ **数据完整**: 确保项目创建时就有完整的空调面积信息  
✅ **便于编辑**: 编辑项目时可以同时修改空调面积表  
✅ **用户友好**: 集成在同一个表单中，操作更直观  

## 后续功能

配置空调面积表后，系统可以：
1. ✅ 自动保存空调面积表
2. ✅ 编辑时加载现有数据
3. 🔄 自动计算部门分配（开发中）
4. 🔄 显示部门分配详情（开发中）

---

**功能已完成！** 现在创建项目时可以直接配置空调面积表了。🎉
