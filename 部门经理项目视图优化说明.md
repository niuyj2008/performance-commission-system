# 部门经理项目视图优化

## 功能说明

优化了部门经理登录后的项目管理界面，实现以下功能：

### 1. 项目列表过滤
- **总经理/财务**：看到所有项目，显示项目总提成
- **部门经理**：只看到本部门有分配的项目，显示部门分配金额
- **普通员工**：看到所有项目（只读）

### 2. 提成金额显示
- **总经理/财务**：`calculated_commission` 显示项目总提成
- **部门经理**：`calculated_commission` 显示部门分配金额（从 `department_allocations` 表获取）

### 3. 额外字段
部门经理查看项目时，返回的项目对象包含以下额外字段：
- `department_allocated_amount`: 部门分配金额
- `department_weight`: 部门权重
- `is_manager_view`: true（标识这是部门经理视图）
- `department_code`: 部门代码

## 修改的文件

### server/routes/projects.js
1. **GET /api/projects** - 获取项目列表
   - 添加角色判断逻辑
   - 部门经理使用 INNER JOIN 查询 `department_allocations` 表
   - 只返回有部门分配的项目
   - 将 `calculated_commission` 替换为 `department_allocated_amount`

2. **GET /api/projects/:id** - 获取单个项目详情
   - 添加角色判断逻辑
   - 部门经理查看时，从 `department_allocations` 获取部门分配金额
   - 替换 `calculated_commission` 字段

## 测试结果

### 测试场景
- 总经理登录：看到 14 个项目
- 建筑部经理登录：只看到 1 个项目（韶谷数码城）
  - 项目总提成：176,435 元
  - 建筑部分配金额：47,085.57 元（显示给部门经理）

### 测试脚本
- `test-manager-view.sh`: 测试部门经理项目视图

## 数据库说明

### 相关表
1. **projects**: 项目表
   - `calculated_commission`: 项目总提成

2. **department_allocations**: 部门分配表
   - `project_id`: 项目ID
   - `department_id`: 部门代码（如 "arch", "structure"）
   - `allocated_amount`: 部门分配金额
   - `allocation_weight`: 部门权重

3. **departments**: 部门表
   - `id`: 部门ID
   - `code`: 部门代码（如 "ARCH", "STRUCT"）

### 注意事项
- `department_allocations.department_id` 使用小写代码（如 "arch"）
- `departments.code` 使用大写代码（如 "ARCH"）
- 查询时使用 `LOWER()` 函数处理大小写不匹配

## API 响应示例

### 总经理查看项目
```json
{
  "projects": [
    {
      "id": 2,
      "code": "SGSMCC",
      "name": "韶谷数码城",
      "calculated_commission": 176435,
      ...
    }
  ]
}
```

### 部门经理查看项目
```json
{
  "projects": [
    {
      "id": 2,
      "code": "SGSMCC",
      "name": "韶谷数码城",
      "calculated_commission": 47085.57,
      "department_allocated_amount": 47085.57,
      "department_weight": 0.3376,
      "is_manager_view": true,
      "department_code": "ARCH",
      ...
    }
  ]
}
```

## 后续优化建议

1. 前端界面优化
   - 根据 `is_manager_view` 字段调整界面显示
   - 为部门经理显示"部门分配金额"而不是"项目总提成"
   - 添加部门权重显示

2. 权限控制
   - 部门经理只能查看和管理本部门的项目
   - 限制部门经理对其他部门项目的访问

3. 数据一致性
   - 统一 `department_allocations.department_id` 和 `departments.code` 的大小写
   - 或在数据库层面添加约束确保一致性
