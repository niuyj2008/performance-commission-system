# 提成发放节点进度功能实现计划

## 功能概述
添加提成发放节点进度管理功能，允许管理员和财务人员规划项目的提成发放计划，并在各级分配中体现当期发放比例。

## 权限要求
- **可操作角色**：管理员(admin)、财务(finance)
- **只读角色**：部门经理(manager)、普通员工(employee)

## 数据结构

### payment_stages 表
```sql
CREATE TABLE payment_stages (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  project_id INTEGER NOT NULL,
  stage_date TEXT NOT NULL,          -- 日期，如 "202001"
  stage_name TEXT NOT NULL,          -- 阶段名称，如 "施工图"
  previous_ratio REAL NOT NULL,      -- 上期比例（累计已发放）
  current_ratio REAL NOT NULL,       -- 本期比例
  total_ratio REAL NOT NULL,         -- 总比例（累计）
  notes TEXT,                        -- 备注
  created_at DATETIME,
  updated_at DATETIME
)
```

## 功能实现分步计划

### 第一步：后端API（已完成✅）
- [x] 创建数据库表 `payment_stages`
- [x] 创建后端路由 `server/routes/payment-stages.js`
- [x] 注册路由到 `server/index.js`

API端点：
- `GET /api/payment-stages/:projectId` - 获取项目的发放阶段
- `POST /api/payment-stages/:projectId` - 保存发放阶段（需要admin/finance权限）
- `DELETE /api/payment-stages/:projectId/:stageId` - 删除发放阶段

### 第二步：第一级UI - 发放节点规划
在项目详情页面的"第一级：项目总提成"中添加发放节点管理界面。

#### UI组件
1. **发放节点列表表格**
   - 列：日期、阶段、上期比例、本期比例、总比例、操作
   - 显示所有已配置的发放节点
   - 只有admin/finance可以看到"添加"和"编辑"按钮

2. **添加/编辑发放节点模态框**
   - 输入字段：
     - 日期（文本输入，格式如 202001）
     - 阶段名称（文本输入）
     - 本期比例（数字输入，0-100%）
   - 自动计算：
     - 上期比例 = 前面所有阶段的总比例
     - 总比例 = 上期比例 + 本期比例
   - 验证规则：
     - 所有比例之和不能超过100%
     - 本期比例必须大于0

3. **批量编辑模式**
   - 允许一次性配置多个阶段
   - 实时显示累计比例
   - 保存前验证总比例

#### 实现位置
- 文件：`public/project-detail.html`
- 位置：在 `displayLevel1()` 函数中添加发放节点部分
- 只对admin/finance显示编辑功能

### 第三步：第二级 - 部门分配显示当期比例
修改第二级"部门分配"，根据当前选择的发放节点显示对应比例的金额。

#### 修改内容
1. **添加发放节点选择器**
   - 下拉菜单选择发放节点
   - 默认选择最新的节点
   - 显示：日期 - 阶段名称 (本期比例%)

2. **调整部门分配金额显示**
   - 原金额 = 部门总分配额
   - 当期金额 = 原金额 × 当期比例
   - 显示格式：
     ```
     建筑部
     总额：¥100,000
     当期发放 (施工图 75%)：¥75,000
     ```

3. **修改计算逻辑**
   - 在 `displayLevel2()` 中添加发放节点参数
   - 根据选择的节点计算当期金额
   - 保持原有的部门分配比例不变

#### 实现位置
- 文件：`public/project-detail.html`
- 函数：`displayLevel2()`
- 需要加载发放节点数据

### 第四步：第三级 - 个人分配限额控制
修改第三级"个人分配"，确保个人分配总额不超过第二级的当期部门金额。

#### 修改内容
1. **显示当期限额**
   - 在个人分配模态框顶部显示：
     ```
     当期发放节点：202001 - 施工图 (75%)
     部门总额：¥100,000
     当期可分配：¥75,000
     已分配：¥50,000
     剩余：¥25,000
     ```

2. **验证逻辑调整**
   - 前端：输入时实时验证不超过当期限额
   - 后端：保存时验证总额不超过当期限额
   - 错误提示：明确说明是当期限额

3. **历史分配记录**
   - 保存时记录关联的发放节点ID
   - 可以查看不同节点的分配历史

#### 实现位置
- 前端：`public/project-detail.html` 中的个人分配相关函数
- 后端：`server/routes/personal-allocation.js` 验证逻辑

### 第五步：数据关联和历史记录
为了支持多次发放，需要记录每次分配关联的发放节点。

#### 数据库修改
```sql
ALTER TABLE employee_distributions 
ADD COLUMN payment_stage_id INTEGER REFERENCES payment_stages(id);
```

#### 功能
1. 保存个人分配时记录当前选择的发放节点
2. 查询时可以按发放节点筛选
3. 支持查看历史发放记录

## 实现优先级

### P0 - 核心功能（必须实现）
1. ✅ 后端API和数据库表
2. 第一级：发放节点配置UI
3. 第二级：显示当期比例和金额
4. 第三级：基于当期限额的验证

### P1 - 增强功能（建议实现）
1. 发放节点的编辑和删除
2. 历史发放记录查询
3. 发放进度可视化（进度条）

### P2 - 扩展功能（可选）
1. 发放节点模板（常用的发放计划）
2. 批量导入发放计划
3. 发放统计报表

## 技术要点

### 前端
- 使用模态框进行发放节点配置
- 实时计算累计比例
- 下拉选择器切换发放节点
- 动态更新各级金额显示

### 后端
- 事务处理确保数据一致性
- 比例验证（总和不超过100%）
- 级联删除（删除项目时删除发放节点）
- 权限控制（只有admin/finance可以修改）

### 数据流
```
第一级：配置发放节点
  ↓
第二级：选择发放节点 → 计算当期部门金额
  ↓
第三级：基于当期部门金额 → 分配个人提成
```

## 测试计划

### 测试场景
1. **配置发放节点**
   - 添加多个发放阶段
   - 验证比例总和不超过100%
   - 编辑和删除发放节点

2. **第二级显示**
   - 切换不同发放节点
   - 验证金额计算正确
   - 部门经理只能查看，不能修改

3. **第三级分配**
   - 验证不超过当期限额
   - 保存后正确关联发放节点
   - 查看不同节点的分配记录

### 测试账号
- 管理员：admin / admin123
- 财务：finance / finance123
- 部门经理：manager_arch / manager123

## 下一步行动
1. 重启服务器使后端API生效
2. 实现第一级的发放节点配置UI
3. 测试发放节点的增删改查
4. 实现第二级和第三级的联动逻辑

## 相关文件
- `server/db/create-payment-stages.js` - 数据库表创建脚本
- `server/routes/payment-stages.js` - 后端API
- `server/index.js` - 路由注册
- `public/project-detail.html` - 前端UI（待修改）
