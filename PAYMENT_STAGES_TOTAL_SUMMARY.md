# 项目总计已发放金额显示功能

## 功能说明
在第一级和第二级中显示项目的总体发放情况：
1. **项目总提成**：项目的总提成金额
2. **总计已发放**：该项目所有发放节点累计已发放的总金额
3. **总计剩余**：项目总提成 - 总计已发放金额

## 实现内容

### 1. 后端API增强 ✅

**修改文件：** `server/routes/payment-stages.js`

**新增返回数据：**
```javascript
{
  stages: [...],  // 发放节点列表
  total_paid_amount: 150000,  // 项目总计已发放金额
  total_paid_by_department: {  // 按部门统计的总计已发放金额
    "5": 60000,   // 建筑部总计已发放
    "6": 45000,   // 结构部总计已发放
    "7": 30000,   // 给排水部总计已发放
    "8": 15000    // 电气部总计已发放
  }
}
```

**SQL查询：**
```sql
-- 计算项目总计已发放金额（所有发放节点的总和）
SELECT COALESCE(SUM(amount), 0) as total 
FROM employee_distributions 
WHERE project_id = ?

-- 按部门统计项目总计已发放金额
SELECT department_id, COALESCE(SUM(amount), 0) as total 
FROM employee_distributions 
WHERE project_id = ? 
GROUP BY department_id
```

### 2. 第一级UI - 项目总提成下方 ✅

**显示位置：** 项目总提成 → 提成明细下方

**显示效果：**
```
┌─────────────────────────────────────────────────────┐
│ 项目总提成        总计已发放        总计剩余        │
│ ¥200,000         ¥150,000          ¥50,000         │
└─────────────────────────────────────────────────────┘
```

**样式：**
- 背景色：浅蓝色 (#f0f9ff)
- 边框：蓝色 (#91d5ff)
- 项目总提成：蓝色 (#1890ff)
- 总计已发放：绿色 (#52c41a)
- 总计剩余 > 0：橙色 (#faad14)
- 总计剩余 < 0（超发）：红色 (#ff4d4f)

**显示时机：**
- 加载发放节点数据后自动显示
- 保存发放节点后自动更新
- 切换发放节点后自动更新

### 3. 第二级UI - 部门分配顶部 ✅

**显示位置：** 部门分配 → 发放节点选择器下方

**显示效果（管理员/财务视图）：**
```
┌─────────────────────────────────────────────────────┐
│ 项目总体发放情况                                     │
├─────────────────────────────────────────────────────┤
│ 项目总提成        总计已发放        总计剩余        │
│ ¥200,000         ¥150,000          ¥50,000         │
└─────────────────────────────────────────────────────┘
```

**显示条件：**
- 只对管理员和财务显示
- 只在有已发放金额时显示（projectTotalPaid > 0）
- 部门经理不显示此信息

### 4. 数据计算逻辑

**项目总提成：**
```javascript
// 从第一级提成计算结果获取
const totalCommission = data.totalCommission;
```

**总计已发放：**
```javascript
// 从后端API获取（所有发放节点的累计）
const totalPaid = data.total_paid_amount;
```

**总计剩余：**
```javascript
const totalRemaining = totalCommission - totalPaid;
```

**示例计算：**
- 项目总提成：¥200,000
- 发放节点1（施工图 75%）已发放：¥100,000
- 发放节点2（施工图修改 20%）已发放：¥40,000
- 发放节点3（施工图完成 5%）已发放：¥10,000
- **总计已发放：¥150,000**
- **总计剩余：¥50,000**

### 5. 全局变量

```javascript
// 项目总计已发放金额
let projectTotalPaid = 0;

// 按部门统计的总计已发放金额
let projectTotalPaidByDept = {};

// 项目数据（包含总提成）
let projectData = {
  totalCommission: 0,
  // ...
};
```

### 6. 更新机制

**自动更新时机：**
1. 页面加载时：`loadPaymentStages()` → `updateLevel1TotalPaid()`
2. 保存发放节点后：`savePaymentStages()` → `loadPaymentStages()` → 更新显示
3. 切换发放节点后：`onPaymentStageChange()` → `loadLevel2()` → 显示总计信息

**更新函数：**
```javascript
function updateLevel1TotalPaid() {
  const totalPaidContainer = document.getElementById('totalPaidContainer');
  if (!totalPaidContainer) return;
  
  const totalCommission = projectData.totalCommission || 0;
  const remaining = totalCommission - projectTotalPaid;
  
  // 更新显示内容
  totalPaidContainer.innerHTML = `...`;
}
```

## 使用场景

### 场景1：查看项目整体发放进度
1. 管理员登录系统
2. 进入项目详情页面
3. 在第一级查看：
   - 项目总提成：¥200,000
   - 总计已发放：¥150,000
   - 总计剩余：¥50,000
4. 了解项目已发放75%的提成

### 场景2：在第二级查看总体情况
1. 管理员进入项目详情页面
2. 在第二级顶部看到项目总体发放情况
3. 同时看到当前发放节点的部门分配情况
4. 对比总体进度和当前节点进度

### 场景3：监控是否超额发放
1. 管理员查看项目详情
2. 看到总计剩余为负数（红色显示）
3. 意识到已经超额发放
4. 需要检查和调整分配

### 场景4：规划后续发放
1. 管理员查看总计剩余金额
2. 根据剩余金额规划后续发放节点
3. 确保不超过项目总提成

## 测试步骤

### 测试1：第一级显示总计已发放
```bash
# 前置条件
1. 项目总提成：¥200,000
2. 已配置3个发放节点
3. 节点1已发放：¥100,000
4. 节点2已发放：¥40,000
5. 节点3已发放：¥10,000

# 测试步骤
1. 登录管理员账号（admin / admin123）
2. 进入项目详情页面
3. 查看第一级提成明细下方

# 预期结果
显示：
- 项目总提成：¥200,000（蓝色）
- 总计已发放：¥150,000（绿色）
- 总计剩余：¥50,000（橙色）
```

### 测试2：第二级显示总体发放情况
```bash
# 前置条件
同测试1

# 测试步骤
1. 登录管理员账号
2. 进入项目详情页面
3. 查看第二级顶部

# 预期结果
显示"项目总体发放情况"卡片：
- 项目总提成：¥200,000
- 总计已发放：¥150,000
- 总计剩余：¥50,000
```

### 测试3：部门经理视图
```bash
# 前置条件
同测试1

# 测试步骤
1. 登录部门经理账号（manager_arch / manager123）
2. 进入项目详情页面
3. 查看第一级和第二级

# 预期结果
- 第一级：不显示项目总提成信息
- 第二级：不显示项目总体发放情况
- 只显示本部门的分配信息
```

### 测试4：超额发放警告
```bash
# 前置条件
1. 项目总提成：¥200,000
2. 总计已发放：¥210,000（超额）

# 测试步骤
1. 登录管理员账号
2. 进入项目详情页面
3. 查看总计剩余金额

# 预期结果
- 总计剩余：-¥10,000（红色显示）
- 明确提示已超额发放
```

### 测试5：动态更新
```bash
# 前置条件
1. 项目总提成：¥200,000
2. 总计已发放：¥100,000

# 测试步骤
1. 登录管理员账号
2. 进入项目详情页面
3. 在第三级进行新的个人分配（¥20,000）
4. 保存后返回查看第一级和第二级

# 预期结果
- 总计已发放自动更新为：¥120,000
- 总计剩余自动更新为：¥80,000
- 无需手动刷新页面
```

## 数据流

```
页面加载
  ↓
调用 GET /api/payment-stages/:projectId
  ↓
后端查询所有发放节点
  ↓
后端查询 employee_distributions 表
  ↓
计算项目总计已发放金额
  ↓
按部门统计总计已发放金额
  ↓
返回数据给前端
  ↓
前端保存到全局变量
  ↓
更新第一级显示（updateLevel1TotalPaid）
  ↓
更新第二级显示（displayLevel2）
```

## 技术要点

### 1. 全局状态管理
```javascript
// 使用全局变量保存项目总计数据
let projectTotalPaid = 0;
let projectTotalPaidByDept = {};
let projectData = { totalCommission: 0 };
```

### 2. 动态更新机制
```javascript
// 加载发放节点后自动更新显示
async function loadPaymentStages() {
  // 获取数据
  projectTotalPaid = data.total_paid_amount;
  
  // 更新第一级
  updateLevel1TotalPaid();
  
  // 第二级会在 displayLevel2 中自动使用最新数据
}
```

### 3. 条件渲染
```javascript
// 只在有已发放金额时显示
if (isAdminOrFinance && projectTotalPaid > 0) {
  html += `...总体发放情况...`;
}
```

### 4. 颜色标识
```javascript
// 根据剩余金额动态设置颜色
const color = totalRemaining < 0 ? '#ff4d4f' : '#faad14';
```

## 与其他功能的关系

### 1. 与发放节点功能的关系
- 发放节点功能提供单个节点的已发放金额
- 总计功能汇总所有节点的已发放金额

### 2. 与个人分配功能的关系
- 个人分配保存后，总计已发放金额自动更新
- 总计剩余金额实时反映可分配额度

### 3. 与部门分配功能的关系
- 部门分配显示各部门的总计已发放
- 可以对比部门间的发放进度

## 相关文件
- `server/routes/payment-stages.js` - 后端API（总计已发放金额查询）
- `public/project-detail.html` - 前端UI（第一级和第二级显示）
- `PAYMENT_STAGES_COMPLETE_IMPLEMENTATION.md` - 完整实现文档
- `PAYMENT_STAGES_PAID_AMOUNT_DISPLAY.md` - 已发放金额显示文档

## 注意事项

1. **数据一致性**
   - 总计已发放金额 = 所有发放节点的已发放金额之和
   - 实时从数据库查询，确保准确性

2. **权限控制**
   - 只有管理员和财务可以看到项目总体情况
   - 部门经理只能看到本部门信息

3. **性能优化**
   - 使用SQL聚合查询，一次性获取所有数据
   - 避免多次查询数据库

4. **用户体验**
   - 使用颜色区分不同状态
   - 清晰的层级结构（项目总体 → 发放节点 → 部门 → 个人）

5. **边界情况**
   - 总计已发放 = 0：正常显示
   - 总计剩余 < 0：红色警告
   - 未配置发放节点：不显示总计信息

## 总结

项目总计已发放金额显示功能提供了：
- ✅ 项目整体发放进度一目了然
- ✅ 实时监控已发放和剩余金额
- ✅ 防止超额发放
- ✅ 支持多层级查看（项目 → 节点 → 部门）
- ✅ 自动更新，无需手动刷新

系统现在提供了完整的三级发放管理和监控体系：
1. **项目级**：总提成、总计已发放、总计剩余
2. **节点级**：各节点的已发放金额
3. **部门级**：各部门在各节点的已发放金额
4. **个人级**：每个员工的分配记录
