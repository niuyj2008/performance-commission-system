# 空调面积表配置功能说明

## 更新日期
2024年12月14日

## 功能概述

已在项目详情页添加空调面积表配置功能，用户可以为每个项目配置空调面积表，系统将根据空调面积表计算各部门的提成分配。

## 功能位置

**项目详情页** → **第二级：部门分配** → **配置空调面积表**

访问路径：
1. 登录系统
2. 进入"项目管理"
3. 点击某个项目的"查看详情"
4. 在"第二级：部门分配"区域点击"配置空调面积表"按钮

## 功能特性

### 1. 空调面积表配置界面

- **模态框设计**: 弹出式配置界面，不影响主页面
- **表格形式**: 清晰的表格展示，易于编辑
- **动态添加**: 可以添加多条空调类型记录
- **实时编辑**: 支持直接在表格中修改数据

### 2. 支持的空调类型

基于权威文档《韶谷数码城项目奖金发放计算表》，系统支持以下8种空调类型：

| 序号 | 空调形式 | 说明 |
|------|----------|------|
| 1 | 没有空调 | 无空调系统 |
| 2 | 全中央空调 | 含机械排烟、新风等有关暖通设计 |
| 3 | VRV空调（布管） | VRV系统，需要布置管道 |
| 4 | VRV空调（不布管） | VRV系统，不需要布置管道 |
| 5 | 分体空调及消防排烟 | 分体空调配合消防排烟系统 |
| 6 | 仅有分体空调 | 只有分体空调 |
| 7 | 仅有消防排烟 | 只有消防排烟系统 |
| 8 | 地下室通风及消防排烟 | 地下室专用通风和排烟系统 |

### 3. 配置字段

每条空调面积记录包含以下字段：

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| 序号 | 自动 | - | 自动生成，从1开始 |
| 空调形式 | 下拉选择 | ✓ | 从8种类型中选择 |
| 采用空调部位 | 文本 | - | 例如：1#产业用房1~2F |
| 空调面积（㎡） | 数字 | ✓ | 必须大于0 |
| 备注 | 文本 | - | 其他说明信息 |
| 操作 | 按钮 | - | 删除按钮 |

### 4. 操作功能

- **添加记录**: 点击"+ 添加空调类型"按钮
- **编辑记录**: 直接在表格中修改数据
- **删除记录**: 点击每行的"删除"按钮
- **保存配置**: 点击"保存"按钮提交到服务器
- **取消操作**: 点击"取消"按钮关闭模态框

## 使用流程

### 步骤1：打开配置界面

1. 进入项目详情页
2. 找到"第二级：部门分配"区域
3. 点击"配置空调面积表"按钮

### 步骤2：添加空调类型

1. 点击"+ 添加空调类型"按钮
2. 在新增的行中选择空调形式
3. 填写采用空调部位（可选）
4. 输入空调面积（必填）
5. 填写备注（可选）

### 步骤3：编辑和删除

- **编辑**: 直接在表格单元格中修改数据
- **删除**: 点击对应行的"删除"按钮

### 步骤4：保存配置

1. 确认所有数据填写正确
2. 点击"保存"按钮
3. 系统验证数据并保存到数据库
4. 保存成功后自动刷新项目详情

## 数据验证

系统会在保存时进行以下验证：

1. **空调形式**: 必须选择有效的空调类型
2. **空调面积**: 必须大于0
3. **数据完整性**: 确保所有必填字段都已填写

如果验证失败，系统会提示具体的错误信息。

## 后端API

### 获取空调面积表
```
GET /api/air-conditioning/:projectId
```

### 批量保存空调面积表
```
POST /api/air-conditioning/:projectId
Body: {
  "tables": [
    {
      "ac_type": "全中央空调",
      "location": "2#数据中心",
      "area": 23215,
      "notes": "含机械排烟、新风等有关暖通设计"
    },
    ...
  ]
}
```

### 计算部门分配
```
POST /api/air-conditioning/:projectId/calculate-allocation
```

### 获取部门分配结果
```
GET /api/air-conditioning/:projectId/allocations
```

## 数据库表结构

### air_conditioning_tables 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键 |
| project_id | INTEGER | 项目ID（外键） |
| ac_type | TEXT | 空调类型 |
| location | TEXT | 采用空调部位 |
| area | REAL | 空调面积 |
| notes | TEXT | 备注 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

## 与部门分配的关系

配置空调面积表后，系统可以：

1. **计算空调综合系数**: 根据不同空调类型和面积计算综合系数
2. **确定部门比例**: 根据空调综合系数确定各部门的分配比例
3. **计算部门提成**: 将项目总提成按比例分配给各部门

### 部门分配公式

```
部门提成 = 项目总提成 × 阶段比例 × (1 - 总负责比例) × 部门系数
```

其中部门系数根据空调面积表动态计算：
- 建筑部: 基础比例 + 空调系数调整
- 结构部: 基础比例 + 空调系数调整
- 给排水部: 基础比例 + 空调系数调整
- 电气部: 基础比例 + 空调系数调整
- 空调部: 根据空调面积比例计算

## 示例数据

### 示例1：全中央空调项目

| 序号 | 空调形式 | 采用空调部位 | 空调面积 | 备注 |
|------|----------|--------------|----------|------|
| 1 | 全中央空调 | 2#数据中心 | 23215㎡ | 含机械排烟、新风等 |

### 示例2：混合空调项目

| 序号 | 空调形式 | 采用空调部位 | 空调面积 | 备注 |
|------|----------|--------------|----------|------|
| 1 | 全中央空调 | 2#数据中心 | 23215㎡ | 含机械排烟、新风等 |
| 2 | VRV空调（布管） | 1#产业用房1~2F | 1795㎡ | - |
| 3 | VRV空调（不布管） | 1#产业用房3~12F | 10277㎡ | - |

## 注意事项

1. **保存前验证**: 确保所有必填字段都已正确填写
2. **数据覆盖**: 每次保存会覆盖该项目的所有空调面积表数据
3. **删除确认**: 删除记录前会弹出确认对话框
4. **权限要求**: 只有管理员和财务人员可以配置空调面积表
5. **计算顺序**: 需要先计算项目总提成，再配置空调面积表，最后计算部门分配

## 后续功能

配置空调面积表后，可以：

1. ✅ 查看空调面积表配置
2. ✅ 编辑和更新空调面积表
3. 🔄 自动计算部门分配（开发中）
4. 🔄 查看部门分配详情（开发中）
5. 🔄 配置部门内个人分配（开发中）

## 完成状态

✅ 空调面积表配置界面已完成  
✅ 前端交互功能已实现  
✅ 后端API已更新  
✅ 数据验证已实现  
✅ 批量保存功能已实现  
✅ 服务器已重启并运行正常  

---

**功能已上线！** 现在可以在项目详情页配置空调面积表了。
