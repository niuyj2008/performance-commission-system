# 提成计算方法核实报告

## 权威文件
文件：`/Users/tima/Documents/ZhangHR/项目/新规定/韶谷数码城项目奖金发放计算表(20200629）.xls`

## 计算逻辑分析

### 第一级：项目提成总额计算

**公式：**
```
提成单价 = 计算基价 × 提成比例 × 项目规模系数 × 工程类别系数 × 层高系数 × 建筑形式系数 × 裙楼面积比系数 × 地下室面积比系数
总提成 = 提成单价 × 项目面积
```

**示例（华韶数码项目）：**
- 计算基价：22
- 提成比例：0.27
- 项目面积：35287㎡
- 项目规模系数：1.25
- 工程类别系数：1（办公楼）
- 层高系数：1.15（16层）
- 建筑形式系数：1（单体）
- 裙楼面积比系数：0.9（小于10%）
- 地下室面积比系数：1（0.2）

提成单价 = 22 × 0.27 × 1.25 × 1 × 1.15 × 1 × 0.9 × 1 = 7.68元/㎡
总提成 = 7.68 × 35287 = 271,176.18元

### 第二级：阶段分配

- 方案费：15%
- 施工图：85%

示例：
- 方案费 = 271,176.18 × 15% = 40,676.43元
- 施工图 = 271,176.18 × 85% = 230,499.76元

### 第三级：总负责和工种分配

从施工图金额中分配：
- 总负责：7%
- 工种奖金：93%

示例：
- 总负责 = 230,499.76 × 7% = 16,134.98元
- 工种奖金 = 230,499.76 × 93% = 214,364.77元

### 第四级：各工种比例分配（基于空调面积表）

**关键发现：**
表格中第9行显示的"建筑"金额（86,843.21元）实际上是包含了总负责+建筑部门的总和！

验证：
- 总负责：16,134.98元
- 建筑（表格）：86,843.21元
- 建筑实际 = 86,843.21 - 16,134.98 = 70,708.23元（约等于70,225.70元，有小误差）

**正确的理解：**
第9行的列布局是：
- 列2：总负责（16,134.98）
- 列3：建筑部门（包含总负责，86,843.21）
- 列4：结构部门（70,225.70）
- 列5：给排水部门（23,051.29）
- 列6：电气部门（27,338.59）
- 列7：空调部门（21,379.86）

**各工种比例计算（基于空调面积表）：**

空调面积表数据：
| 空调类型 | 面积 | 建筑 | 结构 | 给排水 | 电气 | 空调 |
|---------|------|------|------|--------|------|------|
| 全中央空调 | 23215 | 0.328125 | 0.318125 | 0.104375 | 0.124375 | 0.125 |
| VRV空调（布管） | 1795 | 0.331875 | 0.321875 | 0.105625 | 0.125625 | 0.115 |
| VRV空调（不布管） | 10277 | 0.36 | 0.35 | 0.115 | 0.135 | 0.04 |

**计算方法：**
1. 计算总空调面积：23215 + 1795 + 10277 = 35287㎡
2. 计算各工种的加权平均系数：
   - 建筑 = (23215×0.328125 + 1795×0.331875 + 10277×0.36) / 35287 = 0.3376
   - 结构 = (23215×0.318125 + 1795×0.321875 + 10277×0.35) / 35287 = 0.3276
   - 给排水 = (23215×0.104375 + 1795×0.105625 + 10277×0.115) / 35287 = 0.1075
   - 电气 = (23215×0.124375 + 1795×0.125625 + 10277×0.135) / 35287 = 0.1275
   - 空调 = (23215×0.125 + 1795×0.115 + 10277×0.04) / 35287 = 0.0997

3. 各工种奖金 = 工种奖金总额 × 各工种比例
   - 建筑 = 214,364.77 × 0.3376 = 72,369.34元
   - 结构 = 214,364.77 × 0.3276 = 70,225.70元
   - 给排水 = 214,364.77 × 0.1075 = 23,051.29元
   - 电气 = 214,364.77 × 0.1275 = 27,338.59元
   - 空调 = 214,364.77 × 0.0997 = 21,379.86元

## 与当前实现的对比

### ✅ 正确的部分

1. **第一级计算逻辑正确**：我们的实现使用了类似的系数相乘方式
2. **空调面积表的使用正确**：我们正确地使用了空调面积表来计算部门分配
3. **加权平均计算正确**：我们的部门分配计算使用了加权平均

### ❌ 需要修正的部分

1. **缺少阶段分配**：
   - 权威表格有"方案费15%"和"施工图85%"的分配
   - 我们的实现直接从项目总额分配到部门，缺少这一层

2. **缺少总负责分配**：
   - 权威表格从施工图金额中先分出7%给总负责
   - 剩余93%才是工种奖金
   - 我们的实现中"总负责"是作为一个部门（chief）参与分配的，这是不对的

3. **部门分配的基数错误**：
   - 应该基于"工种奖金（93%）"进行分配
   - 而不是基于项目总提成

4. **配置文件中的系数需要调整**：
   - 需要添加"阶段分配"的配置（方案15%，施工图85%）
   - 需要添加"总负责比例"的配置（7%）
   - 空调类型的系数需要核对

## 建议的修改方案

### 1. 修改计算流程

```
项目总提成
  ↓
阶段分配（方案15% / 施工图85%）
  ↓
施工图金额
  ↓
总负责分配（总负责7% / 工种奖金93%）
  ↓
工种奖金
  ↓
基于空调面积表的各工种分配
```

### 2. 修改配置文件

添加新的配置项：
```json
{
  "stageAllocation": {
    "scheme": 0.15,
    "construction": 0.85
  },
  "chiefAllocation": {
    "chief": 0.07,
    "departments": 0.93
  }
}
```

### 3. 修改计算函数

- `calculateTotalCommission()` - 保持不变
- 添加 `calculateStageAllocation()` - 计算阶段分配
- 修改 `calculateDepartmentAllocation()` - 先分出总负责，再分配工种奖金

### 4. 修改部门列表

配置文件中的"chief"（总负责）不应该参与空调面积表的分配，应该单独处理。

## 结论

当前实现的核心逻辑是正确的，但缺少了两个重要的中间层级：
1. 阶段分配（方案/施工图）
2. 总负责分配

需要调整计算流程和配置文件以符合权威表格的计算方法。
