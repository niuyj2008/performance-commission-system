# 提成计算系统修正总结

## 修正日期
2025-12-14

## 参考文件
`/Users/tima/Documents/ZhangHR/项目/新规定/韶谷数码城项目奖金发放计算表(20200629）.xls`

## 主要修正内容

### 1. 修正了计算流程

**修正前：**
```
项目总提成 → 直接分配到各部门（基于空调面积表）
```

**修正后：**
```
项目总提成 
  ↓
阶段分配（方案15% / 施工图85%）
  ↓
施工图金额
  ↓
总负责分配（总负责7% / 工种奖金93%）
  ↓
工种奖金
  ↓
基于空调面积表的各工种分配（建筑、结构、给排水、电气、空调）
```

### 2. 更新了配置文件

**文件：** `server/config/commission-config.json`

**主要变更：**

1. 添加了阶段分配配置：
```json
"stageAllocation": {
  "scheme": 0.15,      // 方案设计15%
  "construction": 0.85  // 施工图设计85%
}
```

2. 添加了总负责分配配置：
```json
"chiefAllocation": {
  "chief": 0.07,        // 总负责7%
  "departments": 0.93   // 工种奖金93%
}
```

3. 更新了部门列表（移除了chief、creative等，只保留实际工种）：
```json
"departments": [
  { "id": "arch", "name": "建筑部" },
  { "id": "structure", "name": "结构部" },
  { "id": "water", "name": "给排水部" },
  { "id": "electric", "name": "电气部" },
  { "id": "hvac", "name": "空调部" }
]
```

4. 更新了空调类型系数（基于权威表格）：
```json
"centralAC": {
  "name": "全中央空调",
  "coefficients": {
    "arch": 0.328125,
    "structure": 0.318125,
    "water": 0.104375,
    "electric": 0.124375,
    "hvac": 0.125
  }
}
```

### 3. 更新了计算函数

**文件：** `server/utils/commission.js`

**函数：** `calculateDepartmentAllocation()`

**主要变更：**

1. 添加了`stage`参数，用于确定是方案设计还是施工图设计
2. 先根据阶段分配计算阶段金额
3. 从阶段金额中分出总负责（7%）
4. 剩余的工种奖金（93%）再根据空调面积表分配到各工种
5. 返回结果中包含了完整的分配明细

**新的函数签名：**
```javascript
calculateDepartmentAllocation(totalCommission, stage, airConditioningTable)
```

### 4. 更新了API路由

**文件：** `server/routes/air-conditioning.js`

**变更：**
- 调用`calculateDepartmentAllocation()`时传入项目的设计阶段
- 返回结果中包含了阶段信息、总负责金额、工种奖金等详细信息

### 5. 更新了测试

**文件：** `tests/commission.test.js`

**变更：**
- 更新了部门分配测试，使用韶谷数码城项目的实际数据
- 添加了阶段分配的测试
- 验证总负责和工种奖金的比例

**测试结果：** ✅ 所有测试通过（24个测试）

## 验证结果

### 测试项目数据
- 项目：韶谷数码城（模拟）
- 面积：35,287㎡
- 建筑类型：办公楼
- 设计阶段：施工图

### 空调面积表
| 空调类型 | 面积 |
|---------|------|
| 全中央空调 | 23,215㎡ |
| VRV空调（布管） | 1,795㎡ |
| VRV空调（不布管） | 10,277㎡ |

### 计算结果对比

| 项目 | 权威表格 | 系统计算 | 状态 |
|------|---------|---------|------|
| 项目总提成 | 271,176.18元 | 176,435元* | ⚠️ |
| 施工图(85%) | 230,499.76元 | 149,969.75元* | ⚠️ |
| 总负责(7%) | 16,134.98元 | 10,497.88元* | ⚠️ |
| 工种奖金(93%) | 214,364.77元 | 139,471.87元* | ⚠️ |

*注：金额不一致是因为配置文件中的`baseRate`(5元/㎡)与权威表格的提成单价(7.68元/㎡)不同。

### 比例验证

| 比例项 | 预期 | 实际 | 状态 |
|--------|------|------|------|
| 施工图/总提成 | 85% | 85% | ✅ |
| 总负责/施工图 | 7% | 7% | ✅ |
| 工种奖金/施工图 | 93% | 93% | ✅ |
| 各工种比例总和 | 100% | 100% | ✅ |

## 待完成事项

### 1. 调整基础单价配置

**问题：** 配置文件中的`baseRate`需要根据实际项目调整。

**解决方案：** 参见 `CONFIG_UPDATE_GUIDE.md`

**建议：** 采用简化配置方案，直接设置最终的提成单价。

### 2. 前端界面开发

需要创建以下界面：
- 项目管理界面（包含建筑属性选择）
- 空调面积表录入界面
- 提成计算和分配界面
- 部门内分配界面

### 3. 数据导入功能

考虑添加从Excel文件导入项目数据和空调面积表的功能。

## 结论

✅ **核心计算逻辑已修正**
- 计算流程符合权威表格
- 阶段分配正确（方案15%，施工图85%）
- 总负责分配正确（7%）
- 工种奖金分配正确（93%）
- 空调面积表加权计算正确

⚠️ **配置文件需要调整**
- `baseRate`需要根据实际项目设置
- 建议采用简化配置方案

✅ **所有测试通过**
- 24个测试全部通过
- 计算逻辑验证正确

## 相关文档

- `CALCULATION_VERIFICATION.md` - 详细的计算逻辑核实报告
- `CONFIG_UPDATE_GUIDE.md` - 配置文件更新指南
- `IMPLEMENTATION_SUMMARY.md` - 实施总结（旧版）
