# 发放节点已发放金额显示功能

## 功能说明
在第一级和第二级中显示每个发放节点的已发放金额，让用户清楚地看到：
1. 每个发放节点总共已发放多少钱
2. 每个部门在当前发放节点已发放多少钱
3. 每个部门在当前发放节点还剩余多少可发放金额

## 实现内容

### 1. 后端API增强 ✅

**修改文件：** `server/routes/payment-stages.js`

**新增功能：**
- 获取每个发放节点的已发放总金额
- 按部门统计每个发放节点的已发放金额
- 返回数据结构：
  ```javascript
  {
    id: 1,
    stage_name: "施工图",
    current_ratio: 0.75,
    paid_amount: 50000,  // 该节点已发放总金额
    paid_by_department: {
      "5": 20000,  // 建筑部已发放
      "6": 15000,  // 结构部已发放
      "7": 10000,  // 给排水部已发放
      "8": 5000    // 电气部已发放
    }
  }
  ```

**SQL查询：**
```sql
-- 获取发放节点的已发放总金额
SELECT COALESCE(SUM(amount), 0) as total 
FROM employee_distributions 
WHERE payment_stage_id = ?

-- 按部门统计已发放金额
SELECT department_id, COALESCE(SUM(amount), 0) as total 
FROM employee_distributions 
WHERE payment_stage_id = ? 
GROUP BY department_id
```

### 2. 第一级UI - 发放节点表格 ✅

**显示位置：** 项目总提成 → 发放节点规划表格

**新增列：** "已发放金额"

**显示效果：**
| 日期 | 阶段 | 上期比例 | 本期比例 | 总比例 | 已发放金额 | 状态 |
|------|------|----------|----------|--------|------------|------|
| 202001 | 施工图 | 0% | 75% | 75% | ¥50,000 | 已使用(10人) |
| 202007 | 施工图修改 | 75% | 20% | 95% | ¥0 | 未使用 |

**样式：**
- 已发放金额 > 0：绿色加粗显示
- 已发放金额 = 0：灰色显示

### 3. 第二级UI - 部门分配卡片 ✅

**显示位置：** 部门分配 → 各部门卡片

**新增信息：**
- 已发放金额
- 剩余可发放金额

**显示效果（管理员/财务视图）：**
```
建筑部
总额：¥100,000
当期发放 (75%)：¥75,000
─────────────────
已发放：¥50,000
剩余：¥25,000
分配比例：40%
```

**显示效果（部门经理视图）：**
```
建筑部 提成分配
┌─────────────────────────────┐
│ 总分配金额        当期发放   │
│ ¥100,000         ¥75,000    │
│                 (施工图 75%) │
├─────────────────────────────┤
│ 已发放          剩余可发放   │
│ ¥50,000         ¥25,000     │
└─────────────────────────────┘
```

**颜色标识：**
- 已发放金额：绿色 (#52c41a)
- 剩余金额 > 0：橙色 (#faad14)
- 剩余金额 < 0（超发）：红色 (#ff4d4f)

### 4. 数据计算逻辑

**当期可发放金额：**
```javascript
当期可发放金额 = 部门总额 × 当前发放节点比例
```

**剩余可发放金额：**
```javascript
剩余可发放金额 = 当期可发放金额 - 已发放金额
```

**示例：**
- 部门总额：¥100,000
- 当前节点比例：75%
- 当期可发放：¥75,000
- 已发放：¥50,000
- 剩余可发放：¥25,000

### 5. 部门ID映射

**配置文件ID → 数据库ID：**
```javascript
const configIdToDbId = {
  'arch': '5',      // 建筑部
  'structure': '6', // 结构部
  'water': '7',     // 给排水部
  'electric': '8',  // 电气部
  'hvac': '9'       // 空调部
};
```

## 使用场景

### 场景1：查看发放进度
1. 管理员进入项目详情页面
2. 在第一级查看发放节点表格
3. 看到每个节点的已发放金额
4. 了解整体发放进度

### 场景2：部门经理查看本部门发放情况
1. 部门经理登录系统
2. 进入项目详情页面
3. 在第二级看到本部门的：
   - 总分配金额
   - 当期可发放金额
   - 已发放金额
   - 剩余可发放金额
4. 根据剩余金额决定是否继续分配

### 场景3：管理员查看各部门发放情况
1. 管理员进入项目详情页面
2. 选择发放节点（如"施工图 75%"）
3. 在第二级看到所有部门的发放情况
4. 识别哪些部门已发放、哪些还有剩余

### 场景4：防止超额发放
1. 用户在第三级进行个人分配
2. 系统显示当期可分配金额和已发放金额
3. 前端验证：分配总额不超过剩余可发放金额
4. 后端验证：保存时再次检查限额

## 测试步骤

### 测试1：第一级显示已发放金额
```bash
# 前置条件
1. 已配置发放节点（如：202001 - 施工图 - 75%）
2. 已进行个人分配（如：员工A ¥20,000，员工B ¥30,000）

# 测试步骤
1. 登录管理员账号（admin / admin123）
2. 进入项目详情页面
3. 查看第一级"发放节点规划"表格

# 预期结果
- "已发放金额"列显示：¥50,000
- 状态列显示：已使用(2人)
- 行背景色为浅橙色
```

### 测试2：第二级显示部门已发放金额
```bash
# 前置条件
1. 已配置发放节点
2. 建筑部已分配：员工A ¥20,000，员工B ¥30,000
3. 建筑部总额：¥100,000
4. 当前节点比例：75%

# 测试步骤
1. 登录管理员账号
2. 进入项目详情页面
3. 在第二级选择发放节点
4. 查看建筑部卡片

# 预期结果
- 总额：¥100,000
- 当期发放：¥75,000
- 已发放：¥50,000（绿色）
- 剩余：¥25,000（橙色）
```

### 测试3：部门经理视图
```bash
# 前置条件
同测试2

# 测试步骤
1. 登录建筑部经理（manager_arch / manager123）
2. 进入项目详情页面
3. 查看第二级

# 预期结果
- 显示本部门的完整发放信息
- 包含已发放和剩余金额
- 不显示其他部门信息
```

### 测试4：超额发放警告
```bash
# 前置条件
1. 建筑部当期可发放：¥75,000
2. 建筑部已发放：¥70,000

# 测试步骤
1. 登录管理员账号
2. 进入项目详情页面
3. 在第三级尝试分配员工C ¥10,000

# 预期结果
- 前端提示：分配总额超过当期可分配金额
- 剩余金额显示为红色：-¥5,000
- 无法保存
```

### 测试5：切换发放节点
```bash
# 前置条件
1. 配置了多个发放节点
2. 不同节点有不同的已发放金额

# 测试步骤
1. 登录管理员账号
2. 进入项目详情页面
3. 在第二级切换不同的发放节点

# 预期结果
- 各部门的已发放金额随节点切换而变化
- 剩余金额实时更新
- 数据准确无误
```

## 数据流

```
用户查看页面
  ↓
前端调用 GET /api/payment-stages/:projectId
  ↓
后端查询 payment_stages 表
  ↓
后端查询 employee_distributions 表
  ↓
计算每个节点的已发放金额
  ↓
按部门统计已发放金额
  ↓
返回数据给前端
  ↓
前端显示：
  - 第一级：节点总已发放金额
  - 第二级：部门已发放金额和剩余金额
```

## 技术要点

### 1. SQL聚合查询
```sql
-- 高效的聚合查询
SELECT 
  payment_stage_id,
  department_id,
  SUM(amount) as total
FROM employee_distributions
GROUP BY payment_stage_id, department_id
```

### 2. 前端数据映射
```javascript
// 配置文件ID到数据库ID的映射
const configIdToDbId = {
  'arch': '5',
  'structure': '6',
  // ...
};

// 获取部门已发放金额
const paidAmount = selectedPaymentStage.paid_by_department[dbDeptId] || 0;
```

### 3. 实时计算
```javascript
// 当期可发放金额
const currentAmount = totalAmount * currentRatio;

// 剩余可发放金额
const remainingAmount = currentAmount - paidAmount;
```

### 4. 条件渲染
```javascript
// 只在有已发放金额时显示详细信息
${paidAmount > 0 ? `
  <div>已发放：¥${paidAmount.toLocaleString()}</div>
  <div>剩余：¥${remainingAmount.toLocaleString()}</div>
` : ''}
```

## 相关文件
- `server/routes/payment-stages.js` - 后端API（已发放金额查询）
- `public/project-detail.html` - 前端UI（第一级和第二级显示）
- `PAYMENT_STAGES_COMPLETE_IMPLEMENTATION.md` - 完整实现文档
- `PAYMENT_STAGES_AUTO_REFRESH.md` - 自动刷新功能文档

## 注意事项

1. **性能优化**
   - 使用SQL聚合查询，避免多次查询
   - 一次性获取所有发放节点的已发放金额

2. **数据一致性**
   - 已发放金额实时从数据库查询
   - 确保显示的数据与实际分配记录一致

3. **用户体验**
   - 使用颜色区分不同状态（已发放/剩余/超发）
   - 清晰显示金额层级（总额/当期/已发放/剩余）

4. **权限控制**
   - 管理员和财务：查看所有部门
   - 部门经理：只查看本部门

5. **边界情况**
   - 已发放金额 = 0：显示灰色
   - 剩余金额 < 0：显示红色警告
   - 未配置发放节点：不显示已发放信息

## 总结

已发放金额显示功能让用户能够：
- ✅ 实时了解发放进度
- ✅ 清楚看到剩余可发放金额
- ✅ 防止超额发放
- ✅ 提高资金管理透明度

系统现在提供了完整的发放节点管理和监控功能，从规划、执行到跟踪，形成闭环管理。
