# 第二级部门分配功能实现说明

## 更新日期
2024年12月14日

## 功能概述

已实现项目详情页的"第二级：部门分配"功能，系统现在可以根据空调面积表自动计算各部门的提成分配。

## 实现内容

### 1. 前端功能

#### 加载逻辑
- 在`loadProjectDetail()`函数中添加了`loadLevel2()`调用
- 自动检查项目是否配置了空调面积表
- 如果有空调面积表，自动计算并显示部门分配

#### 显示内容
- **阶段信息**: 显示设计阶段（方案/施工图）和阶段金额
- **总负责分配**: 显示总负责的分配金额
- **工种奖金**: 显示各工种的总金额
- **部门卡片**: 以卡片形式展示各部门的分配情况
  - 部门名称
  - 分配金额
  - 分配比例

### 2. 部门分配计算逻辑

#### 计算步骤

1. **阶段分配**
   ```
   阶段金额 = 项目总提成 × 阶段比例
   - 方案设计: 15%
   - 施工图设计: 85%
   ```

2. **总负责分配**
   ```
   总负责金额 = 阶段金额 × 7%
   工种奖金 = 阶段金额 × 93%
   ```

3. **工种分配**
   - 根据空调面积表计算各工种的权重
   - 不同空调类型对应不同的工种系数
   - 按权重分配工种奖金

#### 空调类型系数

基于权威文档，不同空调类型对应的工种系数：

| 空调类型 | 建筑 | 结构 | 给排水 | 电气 | 空调 |
|---------|------|------|--------|------|------|
| 没有空调 | 37.5% | 36.5% | 12% | 14% | 0% |
| 全中央空调 | 32.8125% | 31.8125% | 10.4375% | 12.4375% | 12.5% |
| VRV空调（布管） | 33.1875% | 32.1875% | 10.5625% | 12.5625% | 11.5% |
| VRV空调（不布管） | 36% | 35% | 11.5% | 13.5% | 4% |
| 分体空调及消防排烟 | 36.375% | 35.375% | 11.625% | 13.625% | 3% |
| 仅有分体空调 | 36.9375% | 35.9375% | 11.8125% | 13.8125% | 1.5% |
| 仅有消防排烟 | 37.125% | 36.125% | 11.875% | 13.875% | 1% |
| 地下室通风及消防排烟 | 37.3125% | 36.3125% | 11.9375% | 13.9375% | 0.5% |

### 3. API端点

#### 计算部门分配
```
POST /api/air-conditioning/:projectId/calculate-allocation
```

**响应格式**:
```json
{
  "message": "部门分配计算成功",
  "projectId": 1,
  "projectName": "韶关华韶27号地块",
  "totalCommission": 271176.18,
  "stage": "施工图设计",
  "stageAmount": 230499.76,
  "chiefAmount": 16134.98,
  "departmentsAmount": 214364.77,
  "allocations": {
    "chief": {
      "departmentName": "总负责",
      "weight": 0.07,
      "amount": 16134.98
    },
    "architecture": {
      "departmentName": "建筑部",
      "weight": 0.3376,
      "amount": 72384.21
    },
    "structure": {
      "departmentName": "结构部",
      "weight": 0.3276,
      "amount": 70225.70
    },
    ...
  }
}
```

## 使用流程

### 步骤1：创建项目并计算总提成
1. 进入"项目管理"
2. 创建项目（填写建筑面积等信息）
3. 点击"计算提成"

### 步骤2：配置空调面积表
1. 进入项目详情页
2. 在"第二级：部门分配"区域点击"配置空调面积表"
3. 添加空调类型记录
4. 保存配置

### 步骤3：查看部门分配
1. 保存空调面积表后，页面自动刷新
2. "第二级：部门分配"区域自动显示各部门的分配情况
3. 可以看到：
   - 总负责金额
   - 各部门分配金额
   - 各部门分配比例

## 示例：韶关华韶27号地块项目

### 项目信息
- 项目编号: 2004
- 项目名称: 韶关华韶27号地块
- 建筑面积: 35,287㎡
- 设计阶段: 施工图设计

### 空调面积表
| 序号 | 空调形式 | 采用空调部位 | 空调面积 |
|------|----------|--------------|----------|
| 1 | 全中央空调 | 2#数据中心 | 23,215㎡ |
| 2 | VRV空调（布管） | 1#产业用房1~2F | 1,795㎡ |
| 3 | VRV空调（不布管） | 1#产业用房3~12F | 10,277㎡ |

### 计算结果
- **项目总提成**: ¥271,176.18
- **施工图阶段金额**: ¥230,499.76 (85%)
- **总负责**: ¥16,134.98 (7%)
- **工种奖金**: ¥214,364.77 (93%)

### 部门分配
| 部门 | 分配金额 | 分配比例 |
|------|----------|----------|
| 总负责 | ¥16,134.98 | 7.00% |
| 建筑部 | ¥72,384.21 | 33.76% |
| 结构部 | ¥70,225.70 | 32.76% |
| 给排水部 | ¥23,051.29 | 10.75% |
| 电气部 | ¥27,338.59 | 12.75% |
| 空调部 | ¥21,379.86 | 9.97% |

## 技术实现

### 前端代码
- `public/project-detail.html` - 添加了`loadLevel2()`和`displayLevel2()`函数

### 后端代码
- `server/utils/commission.js` - `calculateDepartmentAllocation()`函数
- `server/routes/air-conditioning.js` - 部门分配计算API

### 配置文件
- `server/config/commission-config.json` - 包含空调类型系数配置

## 注意事项

1. **必须先配置空调面积表**: 没有空调面积表数据时，无法计算部门分配
2. **自动计算**: 保存空调面积表后，系统自动计算部门分配
3. **实时更新**: 修改空调面积表后，部门分配会自动重新计算
4. **权限要求**: 只有管理员和财务人员可以配置空调面积表

## 完成状态

✅ 第二级部门分配计算逻辑已实现  
✅ 前端加载和显示功能已实现  
✅ API端点已实现  
✅ 服务器已重启  
✅ 功能可正常使用  

---

**功能已上线！** 现在可以在项目详情页查看部门分配情况了。
