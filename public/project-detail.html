<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é¡¹ç›®è¯¦æƒ… - ç»©æ•ˆææˆç®¡ç†ç³»ç»Ÿ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 30px;
      margin-bottom: 20px;
    }

    .back-btn {
      display: inline-block;
      padding: 8px 16px;
      background: #f0f0f0;
      border-radius: 4px;
      text-decoration: none;
      color: #333;
      margin-bottom: 20px;
      transition: background 0.3s;
    }

    .back-btn:hover {
      background: #e0e0e0;
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .project-code {
      color: #666;
      font-size: 14px;
    }

    .level-section {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 30px;
      margin-bottom: 20px;
    }

    .level-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .level-title {
      font-size: 20px;
      font-weight: 600;
      color: #333;
    }

    .level-badge {
      padding: 6px 16px;
      border-radius: 16px;
      font-size: 13px;
      font-weight: 500;
    }

    .level-1 {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .level-2 {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }

    .level-3 {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
    }

    .total-amount {
      font-size: 36px;
      font-weight: 600;
      color: #1890ff;
      margin: 20px 0;
    }

    .breakdown-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .breakdown-item {
      background: #fafafa;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #e8e8e8;
    }

    .breakdown-label {
      font-size: 13px;
      color: #666;
      margin-bottom: 5px;
    }

    .breakdown-value {
      font-size: 18px;
      font-weight: 500;
      color: #333;
    }

    .department-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .department-card {
      background: #fafafa;
      padding: 20px;
      border-radius: 8px;
      border: 2px solid #e8e8e8;
      transition: all 0.3s;
    }

    .department-card:hover {
      border-color: #1890ff;
      box-shadow: 0 4px 12px rgba(24,144,255,0.1);
    }

    .department-name {
      font-size: 16px;
      font-weight: 500;
      color: #333;
      margin-bottom: 10px;
    }

    .department-amount {
      font-size: 24px;
      font-weight: 600;
      color: #1890ff;
    }

    .department-weight {
      font-size: 13px;
      color: #999;
      margin-top: 5px;
    }

    .participant-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .participant-table th,
    .participant-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #f0f0f0;
    }

    .participant-table th {
      background: #fafafa;
      font-weight: 500;
      color: #333;
      font-size: 14px;
    }

    .participant-table tr:hover {
      background: #fafafa;
    }

    .btn {
      padding: 10px 24px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #1890ff;
      color: white;
    }

    .btn-primary:hover {
      background: #40a9ff;
    }

    .message {
      padding: 12px 16px;
      border-radius: 4px;
      margin-bottom: 20px;
      display: none;
    }

    .message.success {
      background: #f6ffed;
      border: 1px solid #b7eb8f;
      color: #52c41a;
    }

    .message.error {
      background: #fff2f0;
      border: 1px solid #ffccc7;
      color: #ff4d4f;
    }

    .message.show {
      display: block;
    }

    .loading {
      text-align: center;
      padding: 60px;
      color: #999;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .formula-box {
      background: #f0f5ff;
      padding: 15px;
      border-radius: 6px;
      margin-top: 15px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      color: #1890ff;
      line-height: 1.8;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <a href="/projects.html" class="back-btn">â† è¿”å›é¡¹ç›®åˆ—è¡¨</a>
      <h1 id="projectName">åŠ è½½ä¸­...</h1>
      <div class="project-code" id="projectCode"></div>
    </div>

    <div id="message" class="message"></div>

    <!-- ç¬¬ä¸€çº§ï¼šé¡¹ç›®æ€»ææˆ -->
    <div class="level-section">
      <div class="level-header">
        <div class="level-title">ç¬¬ä¸€çº§ï¼šé¡¹ç›®æ€»ææˆ</div>
        <div class="level-badge level-1">Level 1</div>
      </div>
      
      <div id="level1Content">
        <div class="loading">è®¡ç®—ä¸­...</div>
      </div>
    </div>

    <!-- ç¬¬äºŒçº§ï¼šéƒ¨é—¨åˆ†é… -->
    <div class="level-section">
      <div class="level-header">
        <div class="level-title">ç¬¬äºŒçº§ï¼šéƒ¨é—¨åˆ†é…</div>
        <div class="level-badge level-2">Level 2</div>
      </div>
      
      <div id="level2Content">
        <div class="empty-state">
          <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“Š</div>
          <div>éœ€è¦é…ç½®ç©ºè°ƒé¢ç§¯è¡¨æ‰èƒ½è®¡ç®—éƒ¨é—¨åˆ†é…</div>
          <button class="btn btn-primary" style="margin-top: 15px;" onclick="openAcTableModal()">é…ç½®ç©ºè°ƒé¢ç§¯è¡¨</button>
        </div>
      </div>
    </div>

    <!-- ç¬¬ä¸‰çº§ï¼šä¸ªäººåˆ†é… -->
    <div class="level-section">
      <div class="level-header">
        <div class="level-title">ç¬¬ä¸‰çº§ï¼šä¸ªäººåˆ†é…</div>
        <div class="level-badge level-3">Level 3</div>
      </div>
      
      <div id="level3Content">
        <div class="empty-state">
          <div style="font-size: 48px; margin-bottom: 10px;">ğŸ‘¥</div>
          <div>éœ€è¦åˆ†é…é¡¹ç›®å‚ä¸äººå‘˜æ‰èƒ½è®¡ç®—ä¸ªäººææˆ</div>
          <button class="btn btn-primary" style="margin-top: 15px;" onclick="alert('åŠŸèƒ½å¼€å‘ä¸­')">åˆ†é…å‚ä¸äººå‘˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ç©ºè°ƒé¢ç§¯è¡¨é…ç½®æ¨¡æ€æ¡† -->
  <div id="acTableModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 900px;">
      <div class="modal-header">
        <span>é…ç½®ç©ºè°ƒé¢ç§¯è¡¨</span>
        <span class="close" onclick="closeAcTableModal()">&times;</span>
      </div>
      
      <div style="margin-bottom: 20px;">
        <button class="btn btn-primary" onclick="addAcTableRow()">+ æ·»åŠ ç©ºè°ƒç±»å‹</button>
      </div>
      
      <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: #fafafa;">
              <th style="padding: 12px; text-align: left; border: 1px solid #e8e8e8;">åºå·</th>
              <th style="padding: 12px; text-align: left; border: 1px solid #e8e8e8;">ç©ºè°ƒå½¢å¼</th>
              <th style="padding: 12px; text-align: left; border: 1px solid #e8e8e8;">é‡‡ç”¨ç©ºè°ƒéƒ¨ä½</th>
              <th style="padding: 12px; text-align: left; border: 1px solid #e8e8e8;">ç©ºè°ƒé¢ç§¯ï¼ˆã¡ï¼‰</th>
              <th style="padding: 12px; text-align: left; border: 1px solid #e8e8e8;">å¤‡æ³¨</th>
              <th style="padding: 12px; text-align: center; border: 1px solid #e8e8e8; width: 100px;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="acTableBody">
            <!-- åŠ¨æ€æ·»åŠ è¡Œ -->
          </tbody>
        </table>
      </div>
      
      <div class="form-actions" style="margin-top: 20px;">
        <button type="button" class="btn btn-secondary" onclick="closeAcTableModal()">å–æ¶ˆ</button>
        <button type="button" class="btn btn-primary" onclick="saveAcTable()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <style>
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      overflow: auto;
    }

    .modal-content {
      background-color: white;
      margin: 50px auto;
      padding: 0;
      border-radius: 8px;
      max-width: 600px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .modal-header {
      padding: 20px 30px;
      border-bottom: 1px solid #e8e8e8;
      font-size: 18px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .close {
      font-size: 28px;
      font-weight: bold;
      color: #999;
      cursor: pointer;
      line-height: 1;
    }

    .close:hover {
      color: #333;
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding: 20px 30px;
      border-top: 1px solid #e8e8e8;
    }

    .btn {
      padding: 10px 24px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #1890ff;
      color: white;
    }

    .btn-primary:hover {
      background: #40a9ff;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-danger {
      background: #ff4d4f;
      color: white;
      padding: 6px 12px;
      font-size: 13px;
    }

    .btn-danger:hover {
      background: #ff7875;
    }

    .ac-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
      font-size: 14px;
    }

    .ac-select {
      width: 100%;
      padding: 8px;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
      font-size: 14px;
    }
  </style>

  <script>
    const API_BASE = '/api';
    let token = localStorage.getItem('token');
    let projectId = null;
    let projectData = null;

    if (!token) {
      window.location.href = '/login.html';
    }

    // ä»URLè·å–é¡¹ç›®ID
    const urlParams = new URLSearchParams(window.location.search);
    projectId = urlParams.get('id');

    if (!projectId) {
      alert('é¡¹ç›®IDç¼ºå¤±');
      window.location.href = '/projects.html';
    }

    function showMessage(message, type = 'success') {
      const messageEl = document.getElementById('message');
      messageEl.textContent = message;
      messageEl.className = `message ${type} show`;
      setTimeout(() => messageEl.classList.remove('show'), 3000);
    }

    async function loadProjectDetail() {
      try {
        // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆå¦‚æœè¿˜æ²¡æœ‰åŠ è½½ï¼‰
        if (!currentUserInfo) {
          const userResponse = await fetch(`${API_BASE}/users/me`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (userResponse.ok) {
            const userData = await userResponse.json();
            currentUserInfo = userData.user;
          }
        }
        
        // åŠ è½½é¡¹ç›®åŸºæœ¬ä¿¡æ¯
        const response = await fetch(`${API_BASE}/projects/${projectId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) throw new Error('åŠ è½½é¡¹ç›®å¤±è´¥');
        
        const data = await response.json();
        projectData = data.project;
        
        document.getElementById('projectName').textContent = projectData.name;
        document.getElementById('projectCode').textContent = `é¡¹ç›®ç¼–å·ï¼š${projectData.code}`;
        
        // è®¡ç®—ç¬¬ä¸€çº§ææˆ
        await calculateLevel1();
        
        // åŠ è½½å‘æ”¾èŠ‚ç‚¹æ•°æ®(å¿…é¡»åœ¨ç¬¬äºŒçº§ä¹‹å‰åŠ è½½)
        const isAdminOrFinance = currentUserInfo && (currentUserInfo.role === 'admin' || currentUserInfo.role === 'finance');
        if (isAdminOrFinance) {
          // ç®¡ç†å‘˜å’Œè´¢åŠ¡:åŠ è½½å‘æ”¾èŠ‚ç‚¹å¹¶æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Š
          await loadPaymentStages();
        } else {
          // éƒ¨é—¨ç»ç†:åŠ è½½å‘æ”¾èŠ‚ç‚¹æ•°æ®ç”¨äºè®¡ç®—,ä½†ä¸æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Š
          await loadPaymentStagesForManager();
        }
        
        // åŠ è½½ç¬¬äºŒçº§éƒ¨é—¨åˆ†é…(æ­¤æ—¶å‘æ”¾èŠ‚ç‚¹å·²åŠ è½½)
        await loadLevel2();
        
        // åŠ è½½ç¬¬ä¸‰çº§ä¸ªäººåˆ†é…
        await loadLevel3();
        
      } catch (error) {
        showMessage(error.message, 'error');
      }
    }

    async function calculateLevel1() {
      try {
        const response = await fetch(`${API_BASE}/commission/calculate/${projectId}`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'è®¡ç®—å¤±è´¥');
        }
        
        const data = await response.json();
        displayLevel1(data);
        
      } catch (error) {
        document.getElementById('level1Content').innerHTML = `
          <div class="empty-state">
            <div style="color: #ff4d4f;">${error.message}</div>
            <div style="margin-top: 10px; font-size: 13px; color: #999;">è¯·ç¡®ä¿é¡¹ç›®å·²å¡«å†™å»ºç­‘é¢ç§¯ç­‰å¿…è¦ä¿¡æ¯</div>
          </div>
        `;
      }
    }

    function displayLevel1(data) {
      const content = document.getElementById('level1Content');
      
      // å¦‚æœæ˜¯éƒ¨é—¨ç»ç†ï¼Œä¸æ˜¾ç¤ºé¡¹ç›®æ€»ææˆè¯¦æƒ…
      if (currentUserInfo && currentUserInfo.role === 'manager') {
        content.innerHTML = `
          <div class="empty-state">
            <div style="font-size: 48px; margin-bottom: 10px;">ğŸ”’</div>
            <div style="font-size: 16px; color: #666;">é¡¹ç›®æ€»ææˆä¿¡æ¯ä»…å¯¹ç®¡ç†å‘˜å’Œè´¢åŠ¡å¼€æ”¾</div>
            <div style="font-size: 14px; color: #999; margin-top: 10px;">æ‚¨å¯ä»¥åœ¨ä¸‹æ–¹æŸ¥çœ‹æœ¬éƒ¨é—¨çš„åˆ†é…æƒ…å†µ</div>
          </div>
        `;
        return;
      }
      
      // ç®¡ç†å‘˜å’Œè´¢åŠ¡æŸ¥çœ‹å®Œæ•´ä¿¡æ¯
      let html = `
        <div class="total-amount">
          æ€»ææˆï¼šÂ¥${data.totalCommission.toLocaleString()}
        </div>
        
        <div class="formula-box">
          è®¡ç®—å…¬å¼ï¼šå»ºç­‘é¢ç§¯ Ã— è®¾è®¡è´¹å•ä»· Ã— ææˆæ¯”ä¾‹ Ã— å„é¡¹ç³»æ•°
        </div>
        
        <div class="breakdown-grid">
          <div class="breakdown-item">
            <div class="breakdown-label">å»ºç­‘é¢ç§¯</div>
            <div class="breakdown-value">${projectData.building_area?.toLocaleString() || 0} ã¡</div>
          </div>
          <div class="breakdown-item">
            <div class="breakdown-label">è®¾è®¡è´¹å•ä»·</div>
            <div class="breakdown-value">Â¥${data.breakdown.designFeeUnitPrice || 0}/ã¡</div>
          </div>
          <div class="breakdown-item">
            <div class="breakdown-label">ææˆæ¯”ä¾‹</div>
            <div class="breakdown-value">${((data.breakdown.designFeeCommissionRate || 0) * 100).toFixed(1)}%</div>
          </div>
          <div class="breakdown-item">
            <div class="breakdown-label">è®¾è®¡è´¹ææˆ</div>
            <div class="breakdown-value">Â¥${data.breakdown.designFeeCommission?.toLocaleString() || 0}</div>
          </div>
      `;
      
      if (data.breakdown.airConditioningCommission > 0) {
        html += `
          <div class="breakdown-item">
            <div class="breakdown-label">ç©ºè°ƒé¢ç§¯</div>
            <div class="breakdown-value">${data.breakdown.airConditioningArea?.toLocaleString() || 0} ã¡</div>
          </div>
          <div class="breakdown-item">
            <div class="breakdown-label">ç©ºè°ƒé¢ç§¯ææˆ</div>
            <div class="breakdown-value">Â¥${data.breakdown.airConditioningCommission?.toLocaleString() || 0}</div>
          </div>
        `;
      }
      
      html += `</div>`;
      
      // æ·»åŠ æ€»è®¡å·²å‘æ”¾é‡‘é¢æ˜¾ç¤ºå®¹å™¨
      html += `<div id="totalPaidContainer"></div>`;
      
      // æ·»åŠ å‘æ”¾èŠ‚ç‚¹è§„åˆ’éƒ¨åˆ†ï¼ˆåªå¯¹ç®¡ç†å‘˜å’Œè´¢åŠ¡æ˜¾ç¤ºï¼‰
      const isAdminOrFinance = currentUserInfo && (currentUserInfo.role === 'admin' || currentUserInfo.role === 'finance');
      if (isAdminOrFinance) {
        html += `
          <div style="margin-top: 40px; padding-top: 30px; border-top: 2px solid #f0f0f0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3 style="font-size: 18px; font-weight: 600; color: #333;">å‘æ”¾èŠ‚ç‚¹è§„åˆ’</h3>
              <button class="btn btn-primary" onclick="openPaymentStagesModal()">é…ç½®å‘æ”¾èŠ‚ç‚¹</button>
            </div>
            <div id="paymentStagesTable">
              <div class="loading">åŠ è½½ä¸­...</div>
            </div>
          </div>
        `;
      }
      
      content.innerHTML = html;
      
      // ä¿å­˜é¡¹ç›®æ•°æ®ä¾›åç»­ä½¿ç”¨
      projectData.totalCommission = data.totalCommission;
      
      // åŠ è½½å‘æ”¾èŠ‚ç‚¹æ•°æ®
      if (isAdminOrFinance) {
        loadPaymentStages();
      }
    }

    // ç¬¬äºŒçº§ï¼šéƒ¨é—¨åˆ†é…
    async function loadLevel2() {
      const content = document.getElementById('level2Content');
      
      try {
        // æ£€æŸ¥æ˜¯å¦æœ‰ç©ºè°ƒé¢ç§¯è¡¨æ•°æ®
        const acResponse = await fetch(`${API_BASE}/air-conditioning/${projectId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!acResponse.ok) {
          throw new Error('åŠ è½½ç©ºè°ƒé¢ç§¯è¡¨å¤±è´¥');
        }
        
        const acData = await acResponse.json();
        
        if (!acData.tables || acData.tables.length === 0) {
          // æ²¡æœ‰ç©ºè°ƒé¢ç§¯è¡¨æ•°æ®ï¼Œæ˜¾ç¤ºé…ç½®æŒ‰é’®
          content.innerHTML = `
            <div class="empty-state">
              <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“Š</div>
              <div>éœ€è¦é…ç½®ç©ºè°ƒé¢ç§¯è¡¨æ‰èƒ½è®¡ç®—éƒ¨é—¨åˆ†é…</div>
              <button class="btn btn-primary" style="margin-top: 15px;" onclick="openAcTableModal()">é…ç½®ç©ºè°ƒé¢ç§¯è¡¨</button>
            </div>
          `;
          return;
        }
        
        // æœ‰ç©ºè°ƒé¢ç§¯è¡¨æ•°æ®ï¼Œè®¡ç®—éƒ¨é—¨åˆ†é…
        const allocResponse = await fetch(`${API_BASE}/air-conditioning/${projectId}/calculate-allocation`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!allocResponse.ok) {
          const error = await allocResponse.json();
          throw new Error(error.error || 'è®¡ç®—éƒ¨é—¨åˆ†é…å¤±è´¥');
        }
        
        const allocData = await allocResponse.json();
        displayLevel2(allocData);
        
      } catch (error) {
        console.error('åŠ è½½ç¬¬äºŒçº§å¤±è´¥:', error);
        content.innerHTML = `
          <div class="empty-state">
            <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“Š</div>
            <div>éœ€è¦é…ç½®ç©ºè°ƒé¢ç§¯è¡¨æ‰èƒ½è®¡ç®—éƒ¨é—¨åˆ†é…</div>
            <button class="btn btn-primary" style="margin-top: 15px;" onclick="openAcTableModal()">é…ç½®ç©ºè°ƒé¢ç§¯è¡¨</button>
          </div>
        `;
      }
    }

    // å…¨å±€å˜é‡ï¼šå½“å‰é€‰æ‹©çš„å‘æ”¾èŠ‚ç‚¹
    let selectedPaymentStage = null;
    
    function displayLevel2(data) {
      const content = document.getElementById('level2Content');
      
      console.log('displayLevel2 called with data:', data);
      console.log('currentUserInfo:', currentUserInfo);
      
      // éƒ¨é—¨åç§°æ˜ å°„ï¼ˆä¸é…ç½®æ–‡ä»¶ä¸­çš„IDå¯¹åº”ï¼‰
      const deptNames = {
        'chief': 'æ€»è´Ÿè´£',
        'arch': 'å»ºç­‘éƒ¨',
        'structure': 'ç»“æ„éƒ¨',
        'water': 'ç»™æ’æ°´éƒ¨',
        'electric': 'ç”µæ°”éƒ¨',
        'hvac': 'ç©ºè°ƒéƒ¨'
      };
      
      // éƒ¨é—¨IDæ˜ å°„ï¼ˆæ•°æ®åº“IDåˆ°é…ç½®æ–‡ä»¶IDï¼‰
      const deptIdMap = {
        '5': 'arch',      // å»ºç­‘éƒ¨
        '6': 'structure', // ç»“æ„éƒ¨
        '7': 'water',     // ç»™æ’æ°´éƒ¨
        '8': 'electric',  // ç”µæ°”éƒ¨
        '9': 'hvac'       // ç©ºè°ƒéƒ¨
      };
      
      // å¦‚æœæ²¡æœ‰é€‰æ‹©å‘æ”¾èŠ‚ç‚¹ï¼Œé»˜è®¤é€‰æ‹©æœ€æ–°çš„
      if (!selectedPaymentStage && paymentStages.length > 0) {
        selectedPaymentStage = paymentStages[paymentStages.length - 1];
      }
      
      // è®¡ç®—å½“æœŸæ¯”ä¾‹
      const currentRatio = selectedPaymentStage ? selectedPaymentStage.current_ratio : 1;
      
      // å¦‚æœæ˜¯éƒ¨é—¨ç»ç†ï¼Œåªæ˜¾ç¤ºæœ¬éƒ¨é—¨çš„åˆ†é…
      if (currentUserInfo && currentUserInfo.role === 'manager' && currentUserInfo.department_id) {
        // è°ƒè¯•ä¿¡æ¯
        console.group('ç¬¬äºŒçº§éƒ¨é—¨åˆ†é… - éƒ¨é—¨ç»ç†è§†å›¾');
        console.log('å½“å‰ç”¨æˆ·:', currentUserInfo);
        console.log('éƒ¨é—¨ID(æ•°æ®åº“):', currentUserInfo.department_id);
        
        const userDeptConfigId = deptIdMap[currentUserInfo.department_id];
        console.log('éƒ¨é—¨ID(é…ç½®):', userDeptConfigId);
        console.log('éƒ¨é—¨åç§°:', deptNames[userDeptConfigId]);
        
        if (!userDeptConfigId) {
          console.error('éƒ¨é—¨IDæ˜ å°„å¤±è´¥!');
          console.groupEnd();
          content.innerHTML = `
            <div class="empty-state">
              <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“Š</div>
              <div>æ‚¨çš„éƒ¨é—¨ä¿¡æ¯é…ç½®æœ‰è¯¯</div>
              <div style="font-size: 13px; color: #999; margin-top: 10px;">
                éƒ¨é—¨ID: ${currentUserInfo.department_id} (æ— æ³•æ˜ å°„åˆ°é…ç½®æ–‡ä»¶)
              </div>
            </div>
          `;
          return;
        }
        
        // æŸ¥æ‰¾æœ¬éƒ¨é—¨çš„åˆ†é…
        const myDeptAllocation = data.allocations ? data.allocations[userDeptConfigId] : null;
        console.log('éƒ¨é—¨åˆ†é…æ•°æ®:', myDeptAllocation);
        
        if (!myDeptAllocation) {
          console.warn('æœªæ‰¾åˆ°éƒ¨é—¨åˆ†é…æ•°æ®');
          console.groupEnd();
          content.innerHTML = `
            <div class="empty-state">
              <div style="font-size: 48px; margin-bottom: 10px;">ğŸ“Š</div>
              <div>æ‚¨çš„éƒ¨é—¨ï¼ˆ${deptNames[userDeptConfigId]}ï¼‰æœªå‚ä¸æœ¬é¡¹ç›®çš„ææˆåˆ†é…</div>
            </div>
          `;
          return;
        }
        
        // æ˜¾ç¤ºæœ¬éƒ¨é—¨çš„åˆ†é…ä¿¡æ¯
        const deptName = deptNames[userDeptConfigId];
        const totalAmount = myDeptAllocation.amount;
        
        // ç¡®å®šå½“æœŸæ¯”ä¾‹å’ŒèŠ‚ç‚¹åç§°
        let currentStageName = 'å…¨é¢';
        if (selectedPaymentStage) {
          currentStageName = `${selectedPaymentStage.stage_name} ${(currentRatio * 100).toFixed(1)}%`;
        } else if (paymentStages.length === 0) {
          currentStageName = 'å…¨é¢ (æœªé…ç½®å‘æ”¾èŠ‚ç‚¹)';
        }
        
        const currentAmount = totalAmount * currentRatio;
        
        console.log('é‡‘é¢è®¡ç®—:');
        console.log('  éƒ¨é—¨æ€»é¢:', totalAmount);
        console.log('  æœ¬æœŸæ¯”ä¾‹:', currentRatio);
        console.log('  å½“æœŸå‘æ”¾:', currentAmount);
        console.log('  å‘æ”¾èŠ‚ç‚¹:', selectedPaymentStage);
        
        // è·å–è¯¥éƒ¨é—¨åœ¨å½“å‰å‘æ”¾èŠ‚ç‚¹çš„å·²å‘æ”¾é‡‘é¢
        let paidAmount = 0;
        if (selectedPaymentStage && selectedPaymentStage.paid_by_department) {
          paidAmount = selectedPaymentStage.paid_by_department[currentUserInfo.department_id] || 0;
          console.log('  å·²å‘æ”¾:', paidAmount);
        }
        const remainingAmount = currentAmount - paidAmount;
        console.log('  å‰©ä½™:', remainingAmount);
        console.groupEnd();
        
        let html = `
          <div style="margin-bottom: 20px; padding: 20px; background: #f0f9ff; border-radius: 8px; border: 2px solid #1890ff;">
            <div style="font-size: 18px; font-weight: 600; color: #333; margin-bottom: 15px;">
              ${deptName} ææˆåˆ†é…
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: ${paidAmount > 0 ? '15px' : '0'};">
              <div>
                <div style="font-size: 13px; color: #999; margin-bottom: 5px;">æ€»é¢</div>
                <div style="font-size: 28px; font-weight: 600; color: #666;">
                  Â¥${totalAmount.toLocaleString()}
                </div>
              </div>
              <div>
                <div style="font-size: 13px; color: #1890ff; margin-bottom: 5px;">
                  å½“æœŸå‘æ”¾ (${currentStageName})
                </div>
                <div style="font-size: 28px; font-weight: 600; color: #1890ff;">
                  Â¥${currentAmount.toLocaleString()}
                </div>
              </div>
            </div>
            ${paidAmount > 0 ? `
              <div style="padding-top: 15px; border-top: 1px dashed #91d5ff;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                  <div>
                    <div style="font-size: 13px; color: #666; margin-bottom: 5px;">å·²å‘æ”¾</div>
                    <div style="font-size: 24px; font-weight: 600; color: #52c41a;">
                      Â¥${paidAmount.toLocaleString()}
                    </div>
                  </div>
                  <div>
                    <div style="font-size: 13px; color: #666; margin-bottom: 5px;">å‰©ä½™å¯å‘æ”¾</div>
                    <div style="font-size: 24px; font-weight: 600; color: ${remainingAmount < 0 ? '#ff4d4f' : '#faad14'};">
                      Â¥${remainingAmount.toLocaleString()}
                    </div>
                  </div>
                </div>
              </div>
            ` : ''}
          </div>
          
          <div style="padding: 15px; background: #fafafa; border-radius: 8px;">
            <div style="font-size: 14px; color: #666;">
              é¡¹ç›®é˜¶æ®µï¼š${data.stage === 'scheme' ? 'æ–¹æ¡ˆè®¾è®¡' : 'æ–½å·¥å›¾è®¾è®¡'}
            </div>
            ${!selectedPaymentStage && paymentStages.length === 0 ? `
              <div style="font-size: 13px; color: #fa8c16; margin-top: 10px; padding: 10px; background: #fff7e6; border-radius: 4px;">
                âš ï¸ é¡¹ç›®æœªé…ç½®å‘æ”¾èŠ‚ç‚¹,å½“å‰æ˜¾ç¤ºå…¨é¢åˆ†é…(100%)
              </div>
            ` : ''}
          </div>
        `;
        
        content.innerHTML = html;
        return;
      }
      
      // ç®¡ç†å‘˜å’Œè´¢åŠ¡æŸ¥çœ‹æ‰€æœ‰éƒ¨é—¨åˆ†é…
      let html = '';
      
      // æ·»åŠ å‘æ”¾èŠ‚ç‚¹é€‰æ‹©å™¨ï¼ˆåªå¯¹ç®¡ç†å‘˜å’Œè´¢åŠ¡æ˜¾ç¤ºï¼‰
      const isAdminOrFinance = currentUserInfo && (currentUserInfo.role === 'admin' || currentUserInfo.role === 'finance');
      if (isAdminOrFinance && paymentStages.length > 0) {
        html += `
          <div style="margin-bottom: 20px; padding: 15px; background: #fff7e6; border-radius: 8px; border: 1px solid #ffd591;">
            <div style="display: flex; align-items: center; gap: 15px;">
              <label style="font-weight: 600; color: #333;">é€‰æ‹©å‘æ”¾èŠ‚ç‚¹ï¼š</label>
              <select id="paymentStageSelector" class="ac-select" style="flex: 1; max-width: 400px;" onchange="onPaymentStageChange()">
                ${paymentStages.map((stage, index) => `
                  <option value="${index}" ${selectedPaymentStage && selectedPaymentStage.id === stage.id ? 'selected' : ''}>
                    ${stage.stage_date} - ${stage.stage_name} (æœ¬æœŸ ${(stage.current_ratio * 100).toFixed(1)}%, ç´¯è®¡ ${(stage.total_ratio * 100).toFixed(1)}%)
                  </option>
                `).join('')}
              </select>
            </div>
          </div>
        `;
      }
      
      // æ˜¾ç¤ºé¡¹ç›®æ€»è®¡å·²å‘æ”¾é‡‘é¢ï¼ˆåªå¯¹ç®¡ç†å‘˜å’Œè´¢åŠ¡æ˜¾ç¤ºï¼‰
      if (isAdminOrFinance && projectTotalPaid > 0) {
        // è®¡ç®—é¡¹ç›®æ€»ææˆï¼ˆéœ€è¦ä»ç¬¬ä¸€çº§è·å–ï¼‰
        const totalCommission = projectData?.totalCommission || 0;
        const totalRemaining = totalCommission - projectTotalPaid;
        
        html += `
          <div style="margin-bottom: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px; border: 1px solid #91d5ff;">
            <div style="font-weight: 600; margin-bottom: 10px; color: #333;">é¡¹ç›®æ€»ä½“å‘æ”¾æƒ…å†µ</div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
              <div>
                <div style="font-size: 13px; color: #666;">é¡¹ç›®æ€»ææˆ</div>
                <div style="font-size: 20px; font-weight: 600; color: #1890ff;">Â¥${totalCommission.toLocaleString()}</div>
              </div>
              <div>
                <div style="font-size: 13px; color: #666;">æ€»è®¡å·²å‘æ”¾</div>
                <div style="font-size: 20px; font-weight: 600; color: #52c41a;">Â¥${projectTotalPaid.toLocaleString()}</div>
              </div>
              <div>
                <div style="font-size: 13px; color: #666;">æ€»è®¡å‰©ä½™</div>
                <div style="font-size: 20px; font-weight: 600; color: ${totalRemaining < 0 ? '#ff4d4f' : '#faad14'};">Â¥${totalRemaining.toLocaleString()}</div>
              </div>
            </div>
          </div>
        `;
      }
      
      html += `
        <div style="margin-bottom: 20px;">
          <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
            é˜¶æ®µï¼š${data.stage === 'scheme' ? 'æ–¹æ¡ˆè®¾è®¡' : 'æ–½å·¥å›¾è®¾è®¡'} | 
            é˜¶æ®µé‡‘é¢ï¼šÂ¥${data.stageAmount?.toLocaleString() || 0}
          </div>
          <div style="font-size: 14px; color: #666;">
            æ€»è´Ÿè´£ï¼šÂ¥${data.chiefAmount?.toLocaleString() || 0} | 
            å·¥ç§å¥–é‡‘ï¼šÂ¥${data.departmentsAmount?.toLocaleString() || 0}
          </div>
        </div>
        
        <div class="department-list">
      `;
      
      // æ˜¾ç¤ºå„éƒ¨é—¨åˆ†é…
      if (data.allocations) {
        for (const [deptId, allocation] of Object.entries(data.allocations)) {
          const deptName = deptNames[deptId] || deptId;
          const percentage = (allocation.weight * 100).toFixed(2);
          const totalAmount = allocation.amount;
          const currentAmount = totalAmount * currentRatio;
          
          // è·å–è¯¥éƒ¨é—¨åœ¨å½“å‰å‘æ”¾èŠ‚ç‚¹çš„å·²å‘æ”¾é‡‘é¢
          let paidAmount = 0;
          if (selectedPaymentStage && selectedPaymentStage.paid_by_department) {
            // éœ€è¦å°†é…ç½®æ–‡ä»¶IDæ˜ å°„åˆ°æ•°æ®åº“ID
            const configIdToDbId = {
              'arch': '5',
              'structure': '6',
              'water': '7',
              'electric': '8',
              'hvac': '9'
            };
            const dbDeptId = configIdToDbId[deptId];
            paidAmount = selectedPaymentStage.paid_by_department[dbDeptId] || 0;
          }
          
          const remainingAmount = currentAmount - paidAmount;
          
          html += `
            <div class="department-card">
              <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 10px;">
                ${deptName}
              </div>
              <div style="margin-bottom: 10px;">
                <div style="font-size: 13px; color: #999; margin-bottom: 3px;">æ€»é¢</div>
                <div style="font-size: 20px; font-weight: 600; color: #666;">
                  Â¥${totalAmount.toLocaleString()}
                </div>
              </div>
              <div style="padding-top: 10px; border-top: 1px solid #e8e8e8;">
                <div style="font-size: 13px; color: #1890ff; margin-bottom: 3px;">
                  å½“æœŸå‘æ”¾ ${selectedPaymentStage ? `(${(currentRatio * 100).toFixed(1)}%)` : ''}
                </div>
                <div style="font-size: 24px; font-weight: 600; color: #1890ff;">
                  Â¥${currentAmount.toLocaleString()}
                </div>
              </div>
              ${paidAmount > 0 ? `
                <div style="padding-top: 10px; border-top: 1px dashed #e8e8e8; margin-top: 10px;">
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px;">
                    <div>
                      <div style="color: #999; margin-bottom: 3px;">å·²å‘æ”¾</div>
                      <div style="color: #52c41a; font-weight: 600;">Â¥${paidAmount.toLocaleString()}</div>
                    </div>
                    <div>
                      <div style="color: #999; margin-bottom: 3px;">å‰©ä½™</div>
                      <div style="color: ${remainingAmount < 0 ? '#ff4d4f' : '#faad14'}; font-weight: 600;">Â¥${remainingAmount.toLocaleString()}</div>
                    </div>
                  </div>
                </div>
              ` : ''}
              <div style="font-size: 13px; color: #999; margin-top: 10px;">
                åˆ†é…æ¯”ä¾‹ï¼š${percentage}%
              </div>
            </div>
          `;
        }
      }
      
      html += `</div>`;
      
      content.innerHTML = html;
    }
    
    // å‘æ”¾èŠ‚ç‚¹é€‰æ‹©å˜åŒ–å¤„ç†
    function onPaymentStageChange() {
      const selector = document.getElementById('paymentStageSelector');
      if (selector) {
        const index = parseInt(selector.value);
        selectedPaymentStage = paymentStages[index];
        // é‡æ–°åŠ è½½ç¬¬äºŒçº§æ˜¾ç¤º
        loadLevel2();
      }
    }

    // ç¬¬ä¸‰çº§ï¼šä¸ªäººåˆ†é…
    let currentUserInfo = null;
    
    async function loadLevel3() {
      const content = document.getElementById('level3Content');
      
      try {
        // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
        if (!currentUserInfo) {
          const userResponse = await fetch(`${API_BASE}/users/me`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (userResponse.ok) {
            const userData = await userResponse.json();
            currentUserInfo = userData.user;
          }
        }
        
        // åŠ è½½ä¸ªäººåˆ†é…æ•°æ®
        const response = await fetch(`${API_BASE}/personal-allocation/${projectId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) {
          throw new Error('åŠ è½½ä¸ªäººåˆ†é…å¤±è´¥');
        }
        
        const data = await response.json();
        displayLevel3(data);
        
      } catch (error) {
        console.error('åŠ è½½ç¬¬ä¸‰çº§å¤±è´¥:', error);
        content.innerHTML = `
          <div class="empty-state">
            <div style="font-size: 48px; margin-bottom: 10px;">ğŸ‘¥</div>
            <div>éœ€è¦å…ˆå®Œæˆéƒ¨é—¨åˆ†é…æ‰èƒ½è¿›è¡Œä¸ªäººåˆ†é…</div>
          </div>
        `;
      }
    }
    
    function displayLevel3(data) {
      const content = document.getElementById('level3Content');
      const { allocations, summary } = data;
      
      if (!summary || Object.keys(summary).length === 0) {
        content.innerHTML = `
          <div class="empty-state">
            <div style="font-size: 48px; margin-bottom: 10px;">ğŸ‘¥</div>
            <div>éœ€è¦å…ˆå®Œæˆéƒ¨é—¨åˆ†é…æ‰èƒ½è¿›è¡Œä¸ªäººåˆ†é…</div>
          </div>
        `;
        return;
      }
      
      let html = '';
      
      // å¦‚æœæ˜¯éƒ¨é—¨ç»ç†ï¼Œåªæ˜¾ç¤ºæœ¬éƒ¨é—¨çš„åˆ†é…
      if (currentUserInfo && currentUserInfo.role === 'manager') {
        const deptId = currentUserInfo.department_id;
        const deptSummary = summary[deptId];
        
        if (!deptSummary) {
          content.innerHTML = `
            <div class="empty-state">
              <div style="font-size: 48px; margin-bottom: 10px;">ğŸ‘¥</div>
              <div>æ‚¨çš„éƒ¨é—¨æš‚æ— åˆ†é…æ•°æ®</div>
            </div>
          `;
          return;
        }
        
        html += `
          <div style="margin-bottom: 20px; padding: 20px; background: #f0f9ff; border-radius: 8px; border: 2px solid #1890ff;">
            <div style="font-size: 18px; font-weight: 600; color: #333; margin-bottom: 15px;">
              ${deptSummary.department_name}
            </div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
              <div>
                <div style="font-size: 13px; color: #666;">éƒ¨é—¨æ€»é¢</div>
                <div style="font-size: 20px; font-weight: 600; color: #1890ff;">
                  Â¥${deptSummary.total.toLocaleString()}
                </div>
              </div>
              <div>
                <div style="font-size: 13px; color: #666;">å·²åˆ†é…</div>
                <div style="font-size: 20px; font-weight: 600; color: #52c41a;">
                  Â¥${deptSummary.allocated.toLocaleString()}
                </div>
              </div>
              <div>
                <div style="font-size: 13px; color: #666;">å‰©ä½™</div>
                <div style="font-size: 20px; font-weight: 600; color: ${deptSummary.remaining < 0 ? '#ff4d4f' : '#faad14'};">
                  Â¥${deptSummary.remaining.toLocaleString()}
                </div>
              </div>
            </div>
            <div style="margin-top: 15px;">
              <button class="btn btn-primary" onclick="openPersonalAllocationModal(${deptId})">
                åˆ†é…å‚ä¸äººå‘˜
              </button>
            </div>
          </div>
        `;
        
        // æ˜¾ç¤ºå·²åˆ†é…çš„äººå‘˜
        const deptAllocations = allocations.filter(a => a.department_id == deptId);
        if (deptAllocations.length > 0) {
          html += `
            <div style="margin-top: 20px;">
              <div style="font-weight: 600; margin-bottom: 15px;">å‚ä¸äººå‘˜</div>
              <div class="department-list">
          `;
          
          deptAllocations.forEach(alloc => {
            html += `
              <div class="department-card">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                  <div>
                    <div style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 5px;">
                      ${alloc.employee_name}
                    </div>
                    <div style="font-size: 24px; font-weight: 600; color: #1890ff;">
                      Â¥${alloc.amount.toLocaleString()}
                    </div>
                  </div>
                  <button class="btn btn-danger btn-small" onclick="deletePersonalAllocation(${alloc.employee_id})">
                    åˆ é™¤
                  </button>
                </div>
                ${alloc.notes ? `<div style="font-size: 13px; color: #999; margin-top: 10px;">${alloc.notes}</div>` : ''}
              </div>
            `;
          });
          
          html += `
              </div>
            </div>
          `;
        }
        
      } else {
        // ç®¡ç†å‘˜è§†å›¾ï¼šæ˜¾ç¤ºæ‰€æœ‰éƒ¨é—¨
        html += '<div style="font-weight: 600; margin-bottom: 20px;">å„éƒ¨é—¨ä¸ªäººåˆ†é…æƒ…å†µ</div>';
        
        for (const [deptId, deptSummary] of Object.entries(summary)) {
          const deptAllocations = allocations.filter(a => a.department_id == deptId);
          
          html += `
            <div style="margin-bottom: 30px; padding: 20px; background: #fafafa; border-radius: 8px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div style="font-size: 16px; font-weight: 600;">${deptSummary.department_name}</div>
                <div style="font-size: 14px; color: #666;">
                  å·²åˆ†é…: Â¥${deptSummary.allocated.toLocaleString()} / Â¥${deptSummary.total.toLocaleString()}
                  (å‰©ä½™: Â¥${deptSummary.remaining.toLocaleString()})
                </div>
              </div>
          `;
          
          if (deptAllocations.length > 0) {
            html += '<div class="department-list">';
            deptAllocations.forEach(alloc => {
              html += `
                <div class="department-card">
                  <div style="font-size: 14px; font-weight: 600; color: #333;">${alloc.employee_name}</div>
                  <div style="font-size: 20px; font-weight: 600; color: #1890ff; margin-top: 5px;">
                    Â¥${alloc.amount.toLocaleString()}
                  </div>
                </div>
              `;
            });
            html += '</div>';
          } else {
            html += '<div style="color: #999; font-size: 14px;">æš‚æ— åˆ†é…</div>';
          }
          
          html += '</div>';
        }
      }
      
      content.innerHTML = html;
    }

    // ç©ºè°ƒé¢ç§¯è¡¨ç›¸å…³å‡½æ•°
    let acTableData = [];
    let acTableRowCounter = 0;

    // ç©ºè°ƒç±»å‹é€‰é¡¹ï¼ˆåŸºäºæƒå¨æ–‡æ¡£ï¼‰
    const acTypes = [
      'æ²¡æœ‰ç©ºè°ƒ',
      'å…¨ä¸­å¤®ç©ºè°ƒ',
      'VRVç©ºè°ƒï¼ˆå¸ƒç®¡ï¼‰',
      'VRVç©ºè°ƒï¼ˆä¸å¸ƒç®¡ï¼‰',
      'åˆ†ä½“ç©ºè°ƒåŠæ¶ˆé˜²æ’çƒŸ',
      'ä»…æœ‰åˆ†ä½“ç©ºè°ƒ',
      'ä»…æœ‰æ¶ˆé˜²æ’çƒŸ',
      'åœ°ä¸‹å®¤é€šé£åŠæ¶ˆé˜²æ’çƒŸ'
    ];

    // æ‰“å¼€ç©ºè°ƒé¢ç§¯è¡¨é…ç½®æ¨¡æ€æ¡†
    async function openAcTableModal() {
      // åŠ è½½ç°æœ‰çš„ç©ºè°ƒé¢ç§¯è¡¨æ•°æ®
      try {
        const response = await fetch(`${API_BASE}/air-conditioning/${projectId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
          const data = await response.json();
          acTableData = data.tables || [];
        } else {
          acTableData = [];
        }
      } catch (error) {
        console.error('åŠ è½½ç©ºè°ƒé¢ç§¯è¡¨å¤±è´¥:', error);
        acTableData = [];
      }

      // æ¸²æŸ“è¡¨æ ¼
      renderAcTable();
      
      // æ˜¾ç¤ºæ¨¡æ€æ¡†
      document.getElementById('acTableModal').style.display = 'block';
    }

    // å…³é—­ç©ºè°ƒé¢ç§¯è¡¨é…ç½®æ¨¡æ€æ¡†
    function closeAcTableModal() {
      document.getElementById('acTableModal').style.display = 'none';
    }

    // æ¸²æŸ“ç©ºè°ƒé¢ç§¯è¡¨
    function renderAcTable() {
      const tbody = document.getElementById('acTableBody');
      
      if (acTableData.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" style="padding: 40px; text-align: center; color: #999;">
              æš‚æ— æ•°æ®ï¼Œç‚¹å‡»"æ·»åŠ ç©ºè°ƒç±»å‹"å¼€å§‹é…ç½®
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = acTableData.map((row, index) => `
        <tr>
          <td style="padding: 12px; border: 1px solid #e8e8e8;">${index + 1}</td>
          <td style="padding: 12px; border: 1px solid #e8e8e8;">
            <select class="ac-select" data-index="${index}" data-field="ac_type">
              ${acTypes.map(type => `
                <option value="${type}" ${row.ac_type === type ? 'selected' : ''}>${type}</option>
              `).join('')}
            </select>
          </td>
          <td style="padding: 12px; border: 1px solid #e8e8e8;">
            <input type="text" class="ac-input" value="${row.location || ''}" 
                   data-index="${index}" data-field="location" 
                   placeholder="ä¾‹å¦‚ï¼š1#äº§ä¸šç”¨æˆ¿1~2F" />
          </td>
          <td style="padding: 12px; border: 1px solid #e8e8e8;">
            <input type="number" class="ac-input" value="${row.area || ''}" 
                   data-index="${index}" data-field="area" 
                   placeholder="0" step="0.01" min="0" />
          </td>
          <td style="padding: 12px; border: 1px solid #e8e8e8;">
            <input type="text" class="ac-input" value="${row.notes || ''}" 
                   data-index="${index}" data-field="notes" 
                   placeholder="å¤‡æ³¨" />
          </td>
          <td style="padding: 12px; border: 1px solid #e8e8e8; text-align: center;">
            <button class="btn btn-danger" onclick="deleteAcTableRow(${index})">åˆ é™¤</button>
          </td>
        </tr>
      `).join('');

      // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
      tbody.querySelectorAll('.ac-input, .ac-select').forEach(input => {
        input.addEventListener('change', (e) => {
          const index = parseInt(e.target.dataset.index);
          const field = e.target.dataset.field;
          acTableData[index][field] = e.target.value;
        });
      });
    }

    // æ·»åŠ ç©ºè°ƒé¢ç§¯è¡¨è¡Œ
    function addAcTableRow() {
      acTableData.push({
        ac_type: 'æ²¡æœ‰ç©ºè°ƒ',
        location: '',
        area: 0,
        notes: ''
      });
      renderAcTable();
    }

    // åˆ é™¤ç©ºè°ƒé¢ç§¯è¡¨è¡Œ
    function deleteAcTableRow(index) {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
        acTableData.splice(index, 1);
        renderAcTable();
      }
    }

    // ä¿å­˜ç©ºè°ƒé¢ç§¯è¡¨
    async function saveAcTable() {
      try {
        // éªŒè¯æ•°æ®
        for (let i = 0; i < acTableData.length; i++) {
          const row = acTableData[i];
          if (!row.ac_type) {
            alert(`ç¬¬ ${i + 1} è¡Œï¼šè¯·é€‰æ‹©ç©ºè°ƒå½¢å¼`);
            return;
          }
          if (!row.area || row.area <= 0) {
            alert(`ç¬¬ ${i + 1} è¡Œï¼šè¯·è¾“å…¥æœ‰æ•ˆçš„ç©ºè°ƒé¢ç§¯`);
            return;
          }
        }

        // ä¿å­˜åˆ°æœåŠ¡å™¨
        const response = await fetch(`${API_BASE}/air-conditioning/${projectId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ tables: acTableData })
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'ä¿å­˜å¤±è´¥');
        }

        alert('ç©ºè°ƒé¢ç§¯è¡¨ä¿å­˜æˆåŠŸï¼');
        closeAcTableModal();
        
        // é‡æ–°åŠ è½½é¡¹ç›®è¯¦æƒ…ä»¥æ›´æ–°éƒ¨é—¨åˆ†é…
        loadProjectDetail();
        
      } catch (error) {
        console.error('ä¿å­˜ç©ºè°ƒé¢ç§¯è¡¨å¤±è´¥:', error);
        alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);
      }
    }

    // ä¸ªäººåˆ†é…ç›¸å…³å‡½æ•°
    let personalAllocationModal = null;
    let currentDepartmentId = null;
    let departmentEmployees = [];
    let personalAllocations = {};
    
    async function openPersonalAllocationModal(deptId) {
      currentDepartmentId = deptId;
      
      // åˆ›å»ºæ¨¡æ€æ¡†ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
      if (!personalAllocationModal) {
        const modalTitle = 'åˆ†é…å‚ä¸äººå‘˜ï¼ˆå¯è·¨éƒ¨é—¨ï¼‰';
        
        const modalHtml = `
          <div id="personalAllocationModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 800px;">
              <div class="modal-header">
                <span>${modalTitle}</span>
                <span class="close" onclick="closePersonalAllocationModal()">&times;</span>
              </div>
              <div style="padding: 20px 30px;">
                <div id="allocationSummary" style="margin-bottom: 20px;"></div>
                <div id="employeeList"></div>
              </div>
              <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closePersonalAllocationModal()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="savePersonalAllocations()">ä¿å­˜</button>
              </div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        personalAllocationModal = document.getElementById('personalAllocationModal');
      }
      
      // åŠ è½½éƒ¨é—¨å‘˜å·¥
      await loadDepartmentEmployees(deptId);
      
      // æ˜¾ç¤ºæ¨¡æ€æ¡†
      personalAllocationModal.style.display = 'block';
    }
    
    function closePersonalAllocationModal() {
      if (personalAllocationModal) {
        personalAllocationModal.style.display = 'none';
      }
    }
    
    async function loadDepartmentEmployees(deptId) {
      try {
        // æ‰€æœ‰è§’è‰²éƒ½å¯ä»¥åŠ è½½æ‰€æœ‰å‘˜å·¥ï¼ˆæ”¯æŒè·¨éƒ¨é—¨åˆ†é…ï¼‰
        const response = await fetch(`${API_BASE}/users`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) throw new Error('åŠ è½½å‘˜å·¥å¤±è´¥');
        
        const data = await response.json();
        departmentEmployees = data.users || [];
        
        // åŠ è½½ç°æœ‰åˆ†é…
        const allocResponse = await fetch(`${API_BASE}/personal-allocation/${projectId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (allocResponse.ok) {
          const allocData = await allocResponse.json();
          personalAllocations = {};
          allocData.allocations.forEach(alloc => {
            if (alloc.department_id == deptId) {
              personalAllocations[alloc.employee_id] = {
                amount: alloc.amount,
                notes: alloc.notes || ''
              };
            }
          });
          
          // æ›´æ–°æ±‡æ€»ä¿¡æ¯
          const summary = allocData.summary[deptId];
          if (summary) {
            const totalAmount = summary.total;
            const currentRatio = selectedPaymentStage ? selectedPaymentStage.current_ratio : 1;
            const currentLimit = totalAmount * currentRatio;
            
            let summaryHtml = `
              <div style="padding: 15px; background: #f0f9ff; border-radius: 8px; border: 1px solid #1890ff; margin-bottom: 15px;">
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                  <div>
                    <div style="font-size: 13px; color: #666;">éƒ¨é—¨æ€»é¢</div>
                    <div style="font-size: 18px; font-weight: 600; color: #666;">Â¥${totalAmount.toLocaleString()}</div>
                  </div>
                  <div>
                    <div style="font-size: 13px; color: #666;">å·²åˆ†é…</div>
                    <div style="font-size: 18px; font-weight: 600; color: #52c41a;" id="allocatedAmount">Â¥${summary.allocated.toLocaleString()}</div>
                  </div>
                  <div>
                    <div style="font-size: 13px; color: #666;">å‰©ä½™</div>
                    <div style="font-size: 18px; font-weight: 600; color: #faad14;" id="remainingAmount">Â¥${summary.remaining.toLocaleString()}</div>
                  </div>
                </div>
              </div>
            `;
            
            // å¦‚æœæœ‰å‘æ”¾èŠ‚ç‚¹ï¼Œæ˜¾ç¤ºå½“æœŸé™é¢
            if (selectedPaymentStage) {
              summaryHtml += `
                <div style="padding: 15px; background: #fff7e6; border-radius: 8px; border: 1px solid #ffd591;">
                  <div style="font-weight: 600; color: #333; margin-bottom: 10px;">
                    å½“æœŸå‘æ”¾èŠ‚ç‚¹ï¼š${selectedPaymentStage.stage_date} - ${selectedPaymentStage.stage_name}
                  </div>
                  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div>
                      <div style="font-size: 13px; color: #666;">å½“æœŸæ¯”ä¾‹</div>
                      <div style="font-size: 18px; font-weight: 600; color: #fa8c16;">
                        ${(currentRatio * 100).toFixed(1)}%
                      </div>
                    </div>
                    <div>
                      <div style="font-size: 13px; color: #666;">å½“æœŸå¯åˆ†é…é‡‘é¢</div>
                      <div style="font-size: 18px; font-weight: 600; color: #fa8c16;" id="currentLimitAmount">
                        Â¥${currentLimit.toLocaleString()}
                      </div>
                    </div>
                  </div>
                  <div style="margin-top: 10px; font-size: 12px; color: #999;">
                    æç¤ºï¼šä¸ªäººåˆ†é…æ€»é¢ä¸èƒ½è¶…è¿‡å½“æœŸå¯åˆ†é…é‡‘é¢
                  </div>
                </div>
              `;
            }
            
            document.getElementById('allocationSummary').innerHTML = summaryHtml;
          }
        }
        
        // æ¸²æŸ“å‘˜å·¥åˆ—è¡¨
        renderEmployeeList();
        
      } catch (error) {
        console.error('åŠ è½½éƒ¨é—¨å‘˜å·¥å¤±è´¥:', error);
        alert('åŠ è½½å‘˜å·¥å¤±è´¥ï¼š' + error.message);
      }
    }
    
    function renderEmployeeList() {
      const container = document.getElementById('employeeList');
      
      let html = '<div style="max-height: 400px; overflow-y: auto;">';
      
      // æ‰€æœ‰è§’è‰²éƒ½æŒ‰éƒ¨é—¨åˆ†ç»„æ˜¾ç¤º
      // æŒ‰éƒ¨é—¨åˆ†ç»„
      const employeesByDept = {};
      departmentEmployees.forEach(emp => {
        const deptName = emp.department_name || 'æœªåˆ†é…éƒ¨é—¨';
        if (!employeesByDept[deptName]) {
          employeesByDept[deptName] = [];
        }
        employeesByDept[deptName].push(emp);
      });
      
      // æ¸²æŸ“æ¯ä¸ªéƒ¨é—¨
      Object.entries(employeesByDept).forEach(([deptName, employees]) => {
        html += `
          <div style="margin-bottom: 20px;">
            <div style="font-weight: 600; font-size: 15px; color: #1890ff; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid #e8e8e8;">
              ${deptName} (${employees.length}äºº)
            </div>
        `;
        
        employees.forEach(emp => {
          const allocation = personalAllocations[emp.id] || { amount: '', notes: '' };
          const hasAllocation = allocation.amount !== '';
          
          html += `
            <div style="padding: 15px; border: 1px solid #e8e8e8; border-radius: 6px; margin-bottom: 10px; background: ${hasAllocation ? '#f6ffed' : 'white'};">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="flex: 1;">
                  <div style="font-weight: 600; margin-bottom: 5px;">${emp.name}</div>
                  <div style="font-size: 13px; color: #999;">${emp.username}</div>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                  <input 
                    type="number" 
                    class="ac-input" 
                    style="width: 150px;" 
                    placeholder="é‡‘é¢"
                    value="${allocation.amount}"
                    onchange="updateAllocation(${emp.id}, this.value)"
                    min="0"
                    step="0.01"
                  />
                  ${hasAllocation ? `
                    <button class="btn btn-danger btn-small" onclick="removeAllocation(${emp.id})">åˆ é™¤</button>
                  ` : ''}
                </div>
              </div>
            </div>
          `;
        });
        
        html += '</div>';
      });
      
      html += '</div>';
      container.innerHTML = html;
    }
    
    function updateAllocation(employeeId, amount) {
      if (amount && parseFloat(amount) > 0) {
        personalAllocations[employeeId] = {
          amount: parseFloat(amount),
          notes: personalAllocations[employeeId]?.notes || ''
        };
      } else {
        delete personalAllocations[employeeId];
      }
      renderEmployeeList();
      updateSummary();
    }
    
    function removeAllocation(employeeId) {
      delete personalAllocations[employeeId];
      renderEmployeeList();
      updateSummary();
    }
    
    function updateSummary() {
      const total = Object.values(personalAllocations).reduce((sum, alloc) => sum + alloc.amount, 0);
      // è¿™é‡Œéœ€è¦ä»summaryä¸­è·å–éƒ¨é—¨æ€»é¢ï¼Œæš‚æ—¶ç®€åŒ–å¤„ç†
      document.getElementById('allocatedAmount').textContent = `Â¥${total.toLocaleString()}`;
    }
    
    async function savePersonalAllocations() {
      try {
        const allocations = Object.entries(personalAllocations).map(([employeeId, data]) => ({
          employee_id: parseInt(employeeId),
          amount: data.amount,
          notes: data.notes,
          payment_stage_id: selectedPaymentStage ? selectedPaymentStage.id : null
        }));
        
        if (allocations.length === 0) {
          alert('è¯·è‡³å°‘åˆ†é…ä¸€ä¸ªå‘˜å·¥');
          return;
        }
        
        // å‰ç«¯éªŒè¯ï¼šæ£€æŸ¥æ˜¯å¦è¶…è¿‡å½“æœŸé™é¢
        if (selectedPaymentStage) {
          const totalAllocated = allocations.reduce((sum, alloc) => sum + alloc.amount, 0);
          
          // è·å–éƒ¨é—¨æ€»é¢
          const allocResponse = await fetch(`${API_BASE}/personal-allocation/${projectId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          
          if (allocResponse.ok) {
            const allocData = await allocResponse.json();
            const summary = allocData.summary[currentDepartmentId];
            if (summary) {
              const currentLimit = summary.total * selectedPaymentStage.current_ratio;
              if (totalAllocated > currentLimit) {
                alert(`åˆ†é…æ€»é¢ Â¥${totalAllocated.toLocaleString()} è¶…è¿‡å½“æœŸå¯åˆ†é…é‡‘é¢ Â¥${currentLimit.toLocaleString()}`);
                return;
              }
            }
          }
        }
        
        const response = await fetch(`${API_BASE}/personal-allocation/${projectId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ allocations })
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'ä¿å­˜å¤±è´¥');
        }
        
        alert('ä¸ªäººåˆ†é…ä¿å­˜æˆåŠŸï¼');
        closePersonalAllocationModal();
        loadProjectDetail();
        
      } catch (error) {
        console.error('ä¿å­˜ä¸ªäººåˆ†é…å¤±è´¥:', error);
        alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);
      }
    }
    
    async function deletePersonalAllocation(employeeId) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåˆ†é…å—ï¼Ÿ')) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE}/personal-allocation/${projectId}/${employeeId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'åˆ é™¤å¤±è´¥');
        }
        
        alert('åˆ é™¤æˆåŠŸï¼');
        loadProjectDetail();
        
      } catch (error) {
        console.error('åˆ é™¤ä¸ªäººåˆ†é…å¤±è´¥:', error);
        alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
      }
    }

    // ==================== å‘æ”¾èŠ‚ç‚¹ç®¡ç† ====================
    let paymentStages = [];
    let paymentStagesModal = null;
    
    // å…¨å±€å˜é‡ï¼šé¡¹ç›®æ€»è®¡å·²å‘æ”¾é‡‘é¢
    let projectTotalPaid = 0;
    let projectTotalPaidByDept = {};
    
    async function loadPaymentStages() {
      try {
        const response = await fetch(`${API_BASE}/payment-stages/${projectId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) throw new Error('åŠ è½½å‘æ”¾èŠ‚ç‚¹å¤±è´¥');
        
        const data = await response.json();
        paymentStages = data.stages || [];
        projectTotalPaid = data.total_paid_amount || 0;
        projectTotalPaidByDept = data.total_paid_by_department || {};
        
        // é»˜è®¤é€‰æ‹©æœ€æ–°çš„å‘æ”¾èŠ‚ç‚¹
        if (paymentStages.length > 0 && !selectedPaymentStage) {
          selectedPaymentStage = paymentStages[paymentStages.length - 1];
        }
        
        displayPaymentStages();
        
        // æ›´æ–°ç¬¬ä¸€çº§æ˜¾ç¤ºï¼ˆå¦‚æœå·²ç»åŠ è½½ï¼‰
        if (projectData && projectData.totalCommission) {
          updateLevel1TotalPaid();
        }
      } catch (error) {
        console.error('åŠ è½½å‘æ”¾èŠ‚ç‚¹å¤±è´¥:', error);
        document.getElementById('paymentStagesTable').innerHTML = `
          <div class="empty-state">
            <div style="font-size: 14px; color: #999;">æš‚æ— å‘æ”¾èŠ‚ç‚¹æ•°æ®</div>
          </div>
        `;
      }
    }
    
    // ä¸ºéƒ¨é—¨ç»ç†åŠ è½½å‘æ”¾èŠ‚ç‚¹(ä¸æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Š,ä»…ç”¨äºè®¡ç®—)
    async function loadPaymentStagesForManager() {
      try {
        const response = await fetch(`${API_BASE}/payment-stages/${projectId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) {
          console.warn('åŠ è½½å‘æ”¾èŠ‚ç‚¹å¤±è´¥,å°†ä½¿ç”¨é»˜è®¤å€¼');
          paymentStages = [];
          selectedPaymentStage = null;
          return;
        }
        
        const data = await response.json();
        paymentStages = data.stages || [];
        projectTotalPaid = data.total_paid_amount || 0;
        projectTotalPaidByDept = data.total_paid_by_department || {};
        
        // é»˜è®¤é€‰æ‹©æœ€æ–°çš„å‘æ”¾èŠ‚ç‚¹
        if (paymentStages.length > 0 && !selectedPaymentStage) {
          selectedPaymentStage = paymentStages[paymentStages.length - 1];
          console.log('éƒ¨é—¨ç»ç†è§†å›¾ - è‡ªåŠ¨é€‰æ‹©å‘æ”¾èŠ‚ç‚¹:', selectedPaymentStage.stage_date, selectedPaymentStage.stage_name);
        } else if (paymentStages.length === 0) {
          console.warn('é¡¹ç›®æœªé…ç½®å‘æ”¾èŠ‚ç‚¹,å°†ä½¿ç”¨100%ä½œä¸ºé»˜è®¤å€¼');
        }
      } catch (error) {
        console.error('åŠ è½½å‘æ”¾èŠ‚ç‚¹å¤±è´¥:', error);
        // å¦‚æœæ²¡æœ‰å‘æ”¾èŠ‚ç‚¹,ä½¿ç”¨é»˜è®¤å€¼
        paymentStages = [];
        selectedPaymentStage = null;
      }
    }
    
    // æ›´æ–°ç¬¬ä¸€çº§çš„æ€»è®¡å·²å‘æ”¾é‡‘é¢æ˜¾ç¤º
    function updateLevel1TotalPaid() {
      const totalPaidContainer = document.getElementById('totalPaidContainer');
      if (!totalPaidContainer) return;
      
      const totalCommission = projectData.totalCommission || 0;
      const remaining = totalCommission - projectTotalPaid;
      
      totalPaidContainer.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; padding: 20px; background: #f0f9ff; border-radius: 8px; border: 1px solid #91d5ff;">
          <div>
            <div style="font-size: 13px; color: #666; margin-bottom: 5px;">é¡¹ç›®æ€»ææˆ</div>
            <div style="font-size: 24px; font-weight: 600; color: #1890ff;">Â¥${totalCommission.toLocaleString()}</div>
          </div>
          <div>
            <div style="font-size: 13px; color: #666; margin-bottom: 5px;">æ€»è®¡å·²å‘æ”¾</div>
            <div style="font-size: 24px; font-weight: 600; color: #52c41a;">Â¥${projectTotalPaid.toLocaleString()}</div>
          </div>
          <div>
            <div style="font-size: 13px; color: #666; margin-bottom: 5px;">æ€»è®¡å‰©ä½™</div>
            <div style="font-size: 24px; font-weight: 600; color: ${remaining < 0 ? '#ff4d4f' : '#faad14'};">Â¥${remaining.toLocaleString()}</div>
          </div>
        </div>
      `;
    }
    
    function displayPaymentStages() {
      const container = document.getElementById('paymentStagesTable');
      
      if (paymentStages.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div style="font-size: 14px; color: #999;">æš‚æ— å‘æ”¾èŠ‚ç‚¹ï¼Œç‚¹å‡»"é…ç½®å‘æ”¾èŠ‚ç‚¹"å¼€å§‹è§„åˆ’</div>
          </div>
        `;
        return;
      }
      
      let html = `
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: #fafafa;">
              <th style="padding: 12px; text-align: left; border: 1px solid #e8e8e8;">æ—¥æœŸ</th>
              <th style="padding: 12px; text-align: left; border: 1px solid #e8e8e8;">é˜¶æ®µ</th>
              <th style="padding: 12px; text-align: center; border: 1px solid #e8e8e8;">ä¸ŠæœŸæ¯”ä¾‹</th>
              <th style="padding: 12px; text-align: center; border: 1px solid #e8e8e8;">æœ¬æœŸæ¯”ä¾‹</th>
              <th style="padding: 12px; text-align: center; border: 1px solid #e8e8e8;">æ€»æ¯”ä¾‹</th>
              <th style="padding: 12px; text-align: center; border: 1px solid #e8e8e8;">å·²å‘æ”¾é‡‘é¢</th>
              <th style="padding: 12px; text-align: center; border: 1px solid #e8e8e8;">çŠ¶æ€</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      paymentStages.forEach(stage => {
        const isUsed = stage.is_used || false;
        const usageCount = stage.usage_count || 0;
        const paidAmount = stage.paid_amount || 0;
        const rowStyle = isUsed ? 'background: #fff7e6;' : '';
        
        html += `
          <tr style="${rowStyle}">
            <td style="padding: 12px; border: 1px solid #e8e8e8;">${stage.stage_date}</td>
            <td style="padding: 12px; border: 1px solid #e8e8e8;">
              ${stage.stage_name}
              ${isUsed ? '<span style="margin-left: 8px; font-size: 11px; color: #fa8c16;">ğŸ”’</span>' : ''}
            </td>
            <td style="padding: 12px; text-align: center; border: 1px solid #e8e8e8;">${(stage.previous_ratio * 100).toFixed(1)}%</td>
            <td style="padding: 12px; text-align: center; border: 1px solid #e8e8e8; font-weight: 600; color: #1890ff;">${(stage.current_ratio * 100).toFixed(1)}%</td>
            <td style="padding: 12px; text-align: center; border: 1px solid #e8e8e8; font-weight: 600;">${(stage.total_ratio * 100).toFixed(1)}%</td>
            <td style="padding: 12px; text-align: center; border: 1px solid #e8e8e8;">
              ${paidAmount > 0 ? 
                `<span style="color: #52c41a; font-weight: 600;">Â¥${paidAmount.toLocaleString()}</span>` : 
                `<span style="color: #999;">Â¥0</span>`
              }
            </td>
            <td style="padding: 12px; text-align: center; border: 1px solid #e8e8e8;">
              ${isUsed ? 
                `<span style="color: #fa8c16; font-size: 13px;">å·²ä½¿ç”¨ (${usageCount}äºº)</span>` : 
                `<span style="color: #52c41a; font-size: 13px;">æœªä½¿ç”¨</span>`
              }
            </td>
          </tr>
        `;
      });
      
      html += `
          </tbody>
        </table>
      `;
      
      container.innerHTML = html;
    }
    
    function openPaymentStagesModal() {
      if (!paymentStagesModal) {
        const modalHtml = `
          <div id="paymentStagesModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 900px;">
              <div class="modal-header">
                <span>é…ç½®å‘æ”¾èŠ‚ç‚¹</span>
                <span class="close" onclick="closePaymentStagesModal()">&times;</span>
              </div>
              <div style="padding: 20px 30px;">
                <div style="margin-bottom: 20px;">
                  <button class="btn btn-primary" onclick="addPaymentStageRow()">+ æ·»åŠ é˜¶æ®µ</button>
                </div>
                <div style="overflow-x: auto;">
                  <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                      <tr style="background: #fafafa;">
                        <th style="padding: 12px; text-align: left; border: 1px solid #e8e8e8;">æ—¥æœŸ</th>
                        <th style="padding: 12px; text-align: left; border: 1px solid #e8e8e8;">é˜¶æ®µåç§°</th>
                        <th style="padding: 12px; text-align: center; border: 1px solid #e8e8e8;">æœ¬æœŸæ¯”ä¾‹(%)</th>
                        <th style="padding: 12px; text-align: center; border: 1px solid #e8e8e8;">æ€»æ¯”ä¾‹(%)</th>
                        <th style="padding: 12px; text-align: center; border: 1px solid #e8e8e8; width: 100px;">æ“ä½œ</th>
                      </tr>
                    </thead>
                    <tbody id="paymentStagesModalBody">
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closePaymentStagesModal()">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="savePaymentStages()">ä¿å­˜</button>
              </div>
            </div>
          </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        paymentStagesModal = document.getElementById('paymentStagesModal');
      }
      
      // åŠ è½½ç°æœ‰æ•°æ®æˆ–æ·»åŠ ä¸€ä¸ªç©ºè¡Œ
      renderPaymentStagesModal();
      paymentStagesModal.style.display = 'block';
    }
    
    function closePaymentStagesModal() {
      if (paymentStagesModal) {
        paymentStagesModal.style.display = 'none';
      }
    }
    
    function renderPaymentStagesModal() {
      const tbody = document.getElementById('paymentStagesModalBody');
      
      if (paymentStages.length === 0) {
        // æ·»åŠ ä¸€ä¸ªç©ºè¡Œ
        paymentStages = [{
          stage_date: '',
          stage_name: '',
          previous_ratio: 0,
          current_ratio: 0,
          total_ratio: 0,
          is_used: false
        }];
      }
      
      let html = '';
      paymentStages.forEach((stage, index) => {
        const isUsed = stage.is_used || false;
        const usageCount = stage.usage_count || 0;
        const rowStyle = isUsed ? 'background: #fff7e6;' : '';
        const disabledAttr = isUsed ? 'disabled' : '';
        const disabledStyle = isUsed ? 'background: #f5f5f5; cursor: not-allowed;' : '';
        
        html += `
          <tr style="${rowStyle}">
            <td style="padding: 8px; border: 1px solid #e8e8e8;">
              <input type="text" class="ac-input" value="${stage.stage_date}" 
                     onchange="updatePaymentStage(${index}, 'stage_date', this.value)" 
                     placeholder="202001" ${disabledAttr} style="${disabledStyle}" />
              ${isUsed ? `<div style="font-size: 11px; color: #fa8c16; margin-top: 3px;">ğŸ”’ å·²ä½¿ç”¨</div>` : ''}
            </td>
            <td style="padding: 8px; border: 1px solid #e8e8e8;">
              <input type="text" class="ac-input" value="${stage.stage_name}" 
                     onchange="updatePaymentStage(${index}, 'stage_name', this.value)" 
                     placeholder="æ–½å·¥å›¾" ${disabledAttr} style="${disabledStyle}" />
            </td>
            <td style="padding: 8px; border: 1px solid #e8e8e8;">
              <input type="number" class="ac-input" value="${(stage.current_ratio * 100).toFixed(1)}" 
                     onchange="updatePaymentStage(${index}, 'current_ratio', this.value / 100)" 
                     min="0" max="100" step="0.1" style="text-align: center; ${disabledStyle}" ${disabledAttr} />
              ${isUsed ? `<div style="font-size: 11px; color: #fa8c16; margin-top: 3px;">${usageCount}æ¡åˆ†é…è®°å½•</div>` : ''}
            </td>
            <td style="padding: 8px; border: 1px solid #e8e8e8; text-align: center; font-weight: 600;">
              ${(stage.total_ratio * 100).toFixed(1)}%
            </td>
            <td style="padding: 8px; border: 1px solid #e8e8e8; text-align: center;">
              ${isUsed ? 
                `<button class="btn btn-danger btn-small" disabled style="background: #d9d9d9; cursor: not-allowed;" title="å·²ä½¿ç”¨çš„èŠ‚ç‚¹ä¸èƒ½åˆ é™¤">åˆ é™¤</button>` :
                `<button class="btn btn-danger btn-small" onclick="removePaymentStageRow(${index})">åˆ é™¤</button>`
              }
            </td>
          </tr>
        `;
      });
      
      tbody.innerHTML = html;
    }
    
    function addPaymentStageRow() {
      const previousTotal = paymentStages.length > 0 ? 
        paymentStages[paymentStages.length - 1].total_ratio : 0;
      
      paymentStages.push({
        stage_date: '',
        stage_name: '',
        previous_ratio: previousTotal,
        current_ratio: 0,
        total_ratio: previousTotal
      });
      
      renderPaymentStagesModal();
    }
    
    function removePaymentStageRow(index) {
      paymentStages.splice(index, 1);
      recalculatePaymentStages();
      renderPaymentStagesModal();
    }
    
    function updatePaymentStage(index, field, value) {
      paymentStages[index][field] = value;
      recalculatePaymentStages();
      renderPaymentStagesModal();
    }
    
    function recalculatePaymentStages() {
      let cumulative = 0;
      paymentStages.forEach(stage => {
        stage.previous_ratio = cumulative;
        cumulative += parseFloat(stage.current_ratio) || 0;
        stage.total_ratio = cumulative;
      });
    }
    
    async function savePaymentStages() {
      try {
        // éªŒè¯æ•°æ®
        for (let i = 0; i < paymentStages.length; i++) {
          const stage = paymentStages[i];
          if (!stage.stage_date || !stage.stage_name) {
            alert(`ç¬¬${i + 1}ä¸ªé˜¶æ®µçš„æ—¥æœŸå’Œåç§°ä¸èƒ½ä¸ºç©º`);
            return;
          }
          if (stage.current_ratio <= 0) {
            alert(`ç¬¬${i + 1}ä¸ªé˜¶æ®µçš„æœ¬æœŸæ¯”ä¾‹å¿…é¡»å¤§äº0`);
            return;
          }
        }
        
        // éªŒè¯æ€»æ¯”ä¾‹ä¸è¶…è¿‡100%
        const totalRatio = paymentStages[paymentStages.length - 1].total_ratio;
        if (totalRatio > 1) {
          alert(`æ€»æ¯”ä¾‹ä¸èƒ½è¶…è¿‡100%ï¼Œå½“å‰ä¸º${(totalRatio * 100).toFixed(1)}%`);
          return;
        }
        
        const response = await fetch(`${API_BASE}/payment-stages/${projectId}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ stages: paymentStages })
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'ä¿å­˜å¤±è´¥');
        }
        
        alert('å‘æ”¾èŠ‚ç‚¹ä¿å­˜æˆåŠŸï¼');
        closePaymentStagesModal();
        
        // é‡æ–°åŠ è½½å‘æ”¾èŠ‚ç‚¹æ•°æ®
        await loadPaymentStages();
        
        // è‡ªåŠ¨åˆ·æ–°ç¬¬äºŒçº§éƒ¨é—¨åˆ†é…ç•Œé¢
        await loadLevel2();
        
        // æç¤ºç”¨æˆ·æ•°æ®å·²æ›´æ–°
        showMessage('å‘æ”¾èŠ‚ç‚¹å·²æ›´æ–°ï¼Œç¬¬äºŒçº§éƒ¨é—¨åˆ†é…å·²åˆ·æ–°', 'success');
      } catch (error) {
        alert('ä¿å­˜å¤±è´¥: ' + error.message);
      }
    }
    
    loadProjectDetail();
  </script>
</body>
</html>
