<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‘æ”¾è®°å½• - ç»©æ•ˆææˆç®¡ç†ç³»ç»Ÿ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 30px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    h1 {
      color: #333;
      font-size: 28px;
      margin: 0;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .btn-home {
      padding: 10px 20px;
      background: #52c41a;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
    }

    .btn-home:hover {
      background: #73d13d;
    }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .filters {
      display: flex;
      gap: 10px;
      flex: 1;
      flex-wrap: wrap;
    }

    .filters select,
    .filters input {
      padding: 10px 12px;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
      font-size: 14px;
    }

    .btn {
      padding: 10px 24px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
      white-space: nowrap;
    }

    .btn-primary {
      background: #1890ff;
      color: white;
    }

    .btn-primary:hover {
      background: #40a9ff;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 13px;
    }

    .btn-danger {
      background: #ff4d4f;
      color: white;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      margin-top: 20px;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #f0f0f0;
    }

    th {
      background: #fafafa;
      font-weight: 500;
      color: #333;
    }

    tr:hover {
      background: #fafafa;
    }

    .message {
      padding: 12px 16px;
      border-radius: 4px;
      margin-bottom: 20px;
      display: none;
    }

    .message.success {
      background: #f6ffed;
      border: 1px solid #b7eb8f;
      color: #52c41a;
    }

    .message.error {
      background: #fff2f0;
      border: 1px solid #ffccc7;
      color: #ff4d4f;
    }

    .message.show {
      display: block;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 8px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
    }

    .modal-header {
      font-size: 20px;
      font-weight: 500;
      margin-bottom: 20px;
      color: #333;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
      font-size: 14px;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
      font-size: 14px;
    }

    .form-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 30px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .summary-card {
      background: #fafafa;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #f0f0f0;
    }

    .summary-card-title {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
    }

    .summary-card-value {
      font-size: 24px;
      font-weight: 500;
      color: #333;
    }

    .summary-card-unit {
      font-size: 14px;
      color: #999;
      margin-left: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>å‘æ”¾è®°å½•</h1>
      <a href="/index.html" class="btn-home">ğŸ  è¿”å›é¦–é¡µ</a>
    </div>
    <p class="subtitle">æŸ¥çœ‹å’Œç®¡ç†ææˆå‘æ”¾è®°å½•</p>

    <div id="message" class="message"></div>

    <div class="summary-cards" id="summaryCards" style="display:none;">
      <div class="summary-card">
        <div class="summary-card-title">å‘æ”¾æ€»é¢</div>
        <div class="summary-card-value" id="totalAmount">0<span class="summary-card-unit">å…ƒ</span></div>
      </div>
      <div class="summary-card">
        <div class="summary-card-title">å‘æ”¾æ¬¡æ•°</div>
        <div class="summary-card-value" id="totalCount">0<span class="summary-card-unit">æ¬¡</span></div>
      </div>
      <div class="summary-card">
        <div class="summary-card-title">æ¶‰åŠå‘˜å·¥</div>
        <div class="summary-card-value" id="employeeCount">0<span class="summary-card-unit">äºº</span></div>
      </div>
    </div>

    <div class="toolbar">
      <div class="filters">
        <select id="periodFilter">
          <option value="">å…¨éƒ¨æœŸé—´</option>
        </select>
        <select id="projectFilter">
          <option value="">å…¨éƒ¨é¡¹ç›®</option>
        </select>
        <select id="employeeFilter">
          <option value="">å…¨éƒ¨å‘˜å·¥</option>
        </select>
        <button class="btn btn-secondary" onclick="loadRecords()">æŸ¥è¯¢</button>
      </div>
      <button class="btn btn-primary" onclick="showAddModal()">æ·»åŠ å‘æ”¾è®°å½•</button>
    </div>

    <div id="tableContainer">
      <div class="loading">åŠ è½½ä¸­...</div>
    </div>
  </div>

  <!-- æ·»åŠ å‘æ”¾è®°å½•æ¨¡æ€æ¡† -->
  <div id="paymentModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">æ·»åŠ å‘æ”¾è®°å½•</div>
      <form id="paymentForm">
        <div class="form-group">
          <label>é¡¹ç›® *</label>
          <select id="project" required></select>
        </div>

        <div class="form-group">
          <label>å‘˜å·¥ *</label>
          <select id="employee" required></select>
        </div>

        <div class="form-group">
          <label>å‘æ”¾é‡‘é¢ï¼ˆå…ƒï¼‰*</label>
          <input type="number" id="amount" step="0.01" required />
        </div>

        <div class="form-group">
          <label>å‘æ”¾æ—¥æœŸ *</label>
          <input type="date" id="paymentDate" required />
        </div>

        <div class="form-group">
          <label>å‘æ”¾æ‰¹æ¬¡</label>
          <input type="text" id="paymentBatch" placeholder="ä¾‹å¦‚ï¼š2025å¹´ä¸ŠåŠå¹´ç¬¬ä¸€æ‰¹" />
        </div>

        <div class="form-group">
          <label>å¤‡æ³¨</label>
          <input type="text" id="notes" />
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-primary">ä¿å­˜</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_BASE = '/api';
    let token = localStorage.getItem('token');
    let records = [];
    let projects = [];
    let employees = [];

    if (!token) {
      window.location.href = '/login.html';
    }

    function showMessage(message, type = 'success') {
      const messageEl = document.getElementById('message');
      messageEl.textContent = message;
      messageEl.className = `message ${type} show`;
      setTimeout(() => messageEl.classList.remove('show'), 3000);
    }

    async function loadProjects() {
      try {
        const response = await fetch(`${API_BASE}/projects`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) throw new Error('åŠ è½½é¡¹ç›®å¤±è´¥');
        
        const data = await response.json();
        projects = data.projects;
        
        const projectFilter = document.getElementById('projectFilter');
        const projectSelect = document.getElementById('project');
        
        // æå–å”¯ä¸€çš„æœŸé—´
        const periods = [...new Set(projects.map(p => p.period).filter(p => p))];
        const periodFilter = document.getElementById('periodFilter');
        periods.forEach(period => {
          const option = document.createElement('option');
          option.value = period;
          option.textContent = period;
          periodFilter.appendChild(option);
        });
        
        projects.forEach(proj => {
          const option1 = document.createElement('option');
          option1.value = proj.id;
          option1.textContent = `${proj.code} - ${proj.name}`;
          projectFilter.appendChild(option1);
          
          const option2 = document.createElement('option');
          option2.value = proj.id;
          option2.textContent = `${proj.code} - ${proj.name}`;
          projectSelect.appendChild(option2);
        });
      } catch (error) {
        showMessage(error.message, 'error');
      }
    }

    async function loadEmployees() {
      try {
        const response = await fetch(`${API_BASE}/users`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) throw new Error('åŠ è½½å‘˜å·¥å¤±è´¥');
        
        const data = await response.json();
        employees = data.users;
        
        const employeeFilter = document.getElementById('employeeFilter');
        const employeeSelect = document.getElementById('employee');
        
        employees.forEach(emp => {
          const option1 = document.createElement('option');
          option1.value = emp.id;
          option1.textContent = `${emp.name} (${emp.username})`;
          employeeFilter.appendChild(option1);
          
          const option2 = document.createElement('option');
          option2.value = emp.id;
          option2.textContent = `${emp.name} (${emp.username})`;
          employeeSelect.appendChild(option2);
        });
      } catch (error) {
        showMessage(error.message, 'error');
      }
    }

    async function loadRecords() {
      try {
        const period = document.getElementById('periodFilter').value;
        const projectId = document.getElementById('projectFilter').value;
        const userId = document.getElementById('employeeFilter').value;
        
        let url = `${API_BASE}/payment/records?`;
        if (period) url += `period=${period}&`;
        if (projectId) url += `project_id=${projectId}&`;
        if (userId) url += `user_id=${userId}&`;
        
        const response = await fetch(url, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) throw new Error('åŠ è½½è®°å½•å¤±è´¥');
        
        const data = await response.json();
        records = data.records;
        
        renderRecords(records);
        updateSummary(records);
      } catch (error) {
        showMessage(error.message, 'error');
        document.getElementById('tableContainer').innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>';
      }
    }

    function updateSummary(data) {
      const summaryCards = document.getElementById('summaryCards');
      if (data.length === 0) {
        summaryCards.style.display = 'none';
        return;
      }
      
      summaryCards.style.display = 'grid';
      
      const totalAmount = data.reduce((sum, r) => sum + r.amount, 0);
      const uniqueEmployees = new Set(data.map(r => r.user_id)).size;
      
      document.getElementById('totalAmount').innerHTML = `${totalAmount.toLocaleString()}<span class="summary-card-unit">å…ƒ</span>`;
      document.getElementById('totalCount').innerHTML = `${data.length}<span class="summary-card-unit">æ¬¡</span>`;
      document.getElementById('employeeCount').innerHTML = `${uniqueEmployees}<span class="summary-card-unit">äºº</span>`;
    }

    function renderRecords(data) {
      const container = document.getElementById('tableContainer');
      
      if (data.length === 0) {
        container.innerHTML = '<div class="empty-state"><div style="font-size:48px;margin-bottom:16px;">ğŸ“‹</div><div>æš‚æ— å‘æ”¾è®°å½•</div></div>';
        return;
      }
      
      let html = `
        <table>
          <thead>
            <tr>
              <th>å‘æ”¾æ—¥æœŸ</th>
              <th>é¡¹ç›®</th>
              <th>å‘˜å·¥</th>
              <th>éƒ¨é—¨</th>
              <th>é‡‘é¢ï¼ˆå…ƒï¼‰</th>
              <th>å‘æ”¾æ‰¹æ¬¡</th>
              <th>å¤‡æ³¨</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      data.forEach(record => {
        html += `
          <tr>
            <td>${record.payment_date}</td>
            <td>${record.project_code} - ${record.project_name}</td>
            <td>${record.user_name}</td>
            <td>${record.department_name || '-'}</td>
            <td style="font-weight:500;color:#1890ff;">${record.amount.toLocaleString()}</td>
            <td>${record.payment_batch || '-'}</td>
            <td>${record.notes || '-'}</td>
            <td>
              <button class="btn btn-danger btn-small" onclick="deleteRecord(${record.id})">åˆ é™¤</button>
            </td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function showAddModal() {
      document.getElementById('paymentForm').reset();
      document.getElementById('paymentDate').valueAsDate = new Date();
      document.getElementById('paymentModal').classList.add('show');
    }

    function closeModal() {
      document.getElementById('paymentModal').classList.remove('show');
    }

    async function deleteRecord(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å‘æ”¾è®°å½•å—ï¼Ÿ')) return;
      
      try {
        const response = await fetch(`${API_BASE}/payment/records/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) throw new Error('åˆ é™¤å¤±è´¥');
        
        showMessage('å‘æ”¾è®°å½•åˆ é™¤æˆåŠŸ');
        loadRecords();
      } catch (error) {
        showMessage(error.message, 'error');
      }
    }

    document.getElementById('paymentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const data = {
        project_id: document.getElementById('project').value,
        user_id: document.getElementById('employee').value,
        amount: parseFloat(document.getElementById('amount').value),
        payment_date: document.getElementById('paymentDate').value,
        payment_batch: document.getElementById('paymentBatch').value || null,
        notes: document.getElementById('notes').value || null
      };
      
      try {
        const response = await fetch(`${API_BASE}/payment/records`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(data)
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'æ·»åŠ å¤±è´¥');
        }
        
        showMessage('å‘æ”¾è®°å½•æ·»åŠ æˆåŠŸ');
        closeModal();
        loadRecords();
      } catch (error) {
        showMessage(error.message, 'error');
      }
    });

    // é¡µé¢åˆå§‹åŒ–
    async function initPage() {
      try {
        // å¹¶è¡ŒåŠ è½½é¡¹ç›®ã€å‘˜å·¥å’Œè®°å½•æ•°æ®
        await Promise.all([
          loadProjects(),
          loadEmployees(),
          loadRecords()
        ]);
      } catch (error) {
        console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
        showMessage('é¡µé¢åŠ è½½å¤±è´¥,è¯·åˆ·æ–°é‡è¯•', 'error');
      }
    }
    
    initPage();
  </script>
</body>
</html>
