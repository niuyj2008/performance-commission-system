<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é¡¹ç›®ç®¡ç† - ç»©æ•ˆææˆç®¡ç†ç³»ç»Ÿ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 30px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    h1 {
      color: #333;
      font-size: 28px;
      margin: 0;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .btn-home {
      padding: 10px 20px;
      background: #52c41a;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
    }

    .btn-home:hover {
      background: #73d13d;
    }

    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      gap: 10px;
      flex-wrap: wrap;
    }

    .filters {
      display: flex;
      gap: 10px;
      flex: 1;
      flex-wrap: wrap;
    }

    .filters select,
    .filters input {
      padding: 10px 12px;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
      font-size: 14px;
    }

    .btn {
      padding: 10px 24px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
      white-space: nowrap;
    }

    .btn-primary {
      background: #1890ff;
      color: white;
    }

    .btn-primary:hover {
      background: #40a9ff;
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-success {
      background: #52c41a;
      color: white;
    }

    .btn-warning {
      background: #faad14;
      color: white;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 13px;
    }

    .btn-danger {
      background: #ff4d4f;
      color: white;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      margin-top: 20px;
    }

    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #f0f0f0;
    }

    th {
      background: #fafafa;
      font-weight: 500;
      color: #333;
    }

    tr:hover {
      background: #fafafa;
    }

    .message {
      padding: 12px 16px;
      border-radius: 4px;
      margin-bottom: 20px;
      display: none;
    }

    .message.success {
      background: #f6ffed;
      border: 1px solid #b7eb8f;
      color: #52c41a;
    }

    .message.error {
      background: #fff2f0;
      border: 1px solid #ffccc7;
      color: #ff4d4f;
    }

    .message.show {
      display: block;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 8px;
      padding: 30px;
      max-width: 1200px;
      width: 95%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      font-size: 20px;
      font-weight: 500;
      margin-bottom: 20px;
      color: #333;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
      font-size: 14px;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
      font-size: 14px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .checkbox-group input[type="checkbox"] {
      width: auto;
    }

    .form-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 30px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #999;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .commission-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 500;
      background: #e6f7ff;
      color: #1890ff;
    }

    .commission-detail {
      background: #fafafa;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
    }

    .commission-breakdown {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .breakdown-item {
      background: white;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #e8e8e8;
    }

    .breakdown-label {
      font-size: 13px;
      color: #666;
      margin-bottom: 5px;
    }

    .breakdown-value {
      font-size: 20px;
      font-weight: 500;
      color: #1890ff;
    }

    .participants-section {
      margin-top: 20px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 8px;
    }

    .participant-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: white;
      border-radius: 4px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>é¡¹ç›®ç®¡ç†</h1>
      <a href="/index.html" class="btn-home">ğŸ  è¿”å›é¦–é¡µ</a>
    </div>
    <p class="subtitle">åˆ›å»ºé¡¹ç›®ã€è®¡ç®—ææˆã€åˆ†é…å‚ä¸äººå‘˜</p>

    <div id="message" class="message"></div>

    <div class="toolbar">
      <div class="filters">
        <select id="periodFilter">
          <option value="">å…¨éƒ¨æœŸé—´</option>
        </select>
        <select id="stageFilter">
          <option value="">å…¨éƒ¨é˜¶æ®µ</option>
          <option value="scheme">æ–¹æ¡ˆè®¾è®¡</option>
          <option value="construction">æ–½å·¥å›¾è®¾è®¡</option>
          <option value="cooperation">åˆä½œé¡¹ç›®</option>
        </select>
        <button class="btn btn-secondary" onclick="loadProjects()">æŸ¥è¯¢</button>
      </div>
      <button id="createProjectBtn" class="btn btn-primary" onclick="showAddModal()" style="display: none;">åˆ›å»ºé¡¹ç›®</button>
    </div>

    <div id="tableContainer">
      <div class="loading">åŠ è½½ä¸­...</div>
    </div>
  </div>

  <!-- åˆ›å»º/ç¼–è¾‘é¡¹ç›®æ¨¡æ€æ¡† -->
  <div id="projectModal" class="modal">
    <div class="modal-content">
      <div class="modal-header" id="modalTitle">åˆ›å»ºé¡¹ç›®</div>
      <form id="projectForm">
        <input type="hidden" id="projectId" />
        
        <div class="form-row">
          <div class="form-group">
            <label>é¡¹ç›®ç¼–å· *</label>
            <input type="text" id="code" required />
          </div>
          <div class="form-group">
            <label>é¡¹ç›®åç§° *</label>
            <input type="text" id="name" required />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>è®¾è®¡é˜¶æ®µ</label>
            <select id="stage">
              <option value="scheme">æ–¹æ¡ˆè®¾è®¡</option>
              <option value="construction" selected>æ–½å·¥å›¾è®¾è®¡</option>
              <option value="cooperation">åˆä½œé¡¹ç›®</option>
            </select>
          </div>
          <div class="form-group">
            <label>å»ºç­‘ç±»å‹</label>
            <select id="buildingType">
              <option value="office">åŠå…¬å»ºç­‘</option>
              <option value="residential">ä½å®…å»ºç­‘</option>
              <option value="school">å­¦æ ¡å»ºç­‘</option>
              <option value="commercial">å•†ä¸šå»ºç­‘</option>
              <option value="industrial">å·¥ä¸šå»ºç­‘</option>
              <option value="other" selected>å…¶ä»–</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>å»ºç­‘é¢ç§¯ï¼ˆã¡ï¼‰</label>
            <input type="number" id="buildingArea" step="0.01" />
          </div>
          <div class="form-group">
            <label>æœŸé—´</label>
            <input type="text" id="period" placeholder="ä¾‹å¦‚ï¼š2025å¹´ä¸ŠåŠå¹´" />
          </div>
        </div>

        <div class="form-group">
          <label>é¡¹ç›®å±æ€§</label>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
            <div class="checkbox-group">
              <input type="checkbox" id="hasBasement" />
              <label for="hasBasement" style="margin: 0;">å«åœ°ä¸‹å®¤</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="hasCivilDefense" />
              <label for="hasCivilDefense" style="margin: 0;">å«äººé˜²</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="isGreenBuilding" />
              <label for="isGreenBuilding" style="margin: 0;">ç»¿è‰²å»ºç­‘</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="isPrefabricated" />
              <label for="isPrefabricated" style="margin: 0;">è£…é…å¼å»ºç­‘</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="isReportingProject" />
              <label for="isReportingProject" style="margin: 0;">æŠ¥å»ºé¡¹ç›®</label>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="isReviewProject" />
              <label for="isReviewProject" style="margin: 0;">å®¡å›¾é¡¹ç›®</label>
            </div>
          </div>
        </div>

        <!-- ç©ºè°ƒé¢ç§¯è¡¨é…ç½® -->
        <div class="form-group" style="margin-top: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <label style="margin: 0;">ç©ºè°ƒé¢ç§¯è¡¨</label>
            <button type="button" class="btn btn-small btn-primary" onclick="addAcRow()">+ æ·»åŠ </button>
          </div>
          
          <div style="overflow-x: auto; max-height: 300px; overflow-y: auto; border: 1px solid #e8e8e8; border-radius: 4px;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead style="position: sticky; top: 0; background: #fafafa; z-index: 1;">
                <tr>
                  <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e8e8e8; font-size: 13px;">åºå·</th>
                  <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e8e8e8; font-size: 13px;">ç©ºè°ƒå½¢å¼ *</th>
                  <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e8e8e8; font-size: 13px;">é‡‡ç”¨ç©ºè°ƒéƒ¨ä½</th>
                  <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e8e8e8; font-size: 13px;">ç©ºè°ƒé¢ç§¯ï¼ˆã¡ï¼‰*</th>
                  <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e8e8e8; font-size: 13px;">å¤‡æ³¨</th>
                  <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e8e8e8; font-size: 13px; width: 80px;">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="acTableBody">
                <tr>
                  <td colspan="6" style="padding: 30px; text-align: center; color: #999; font-size: 13px;">
                    æš‚æ— æ•°æ®ï¼Œç‚¹å‡»"+ æ·»åŠ "æŒ‰é’®æ·»åŠ ç©ºè°ƒé¢ç§¯è®°å½•
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-primary">ä¿å­˜</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ææˆè®¡ç®—æ¨¡æ€æ¡† -->
  <div id="commissionModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">ææˆè®¡ç®—ç»“æœ</div>
      <div id="commissionContent"></div>
      <div class="form-actions">
        <button type="button" class="btn btn-primary" onclick="closeCommissionModal()">å…³é—­</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '/api';
    let token = localStorage.getItem('token');
    let projects = [];
    let acTableData = []; // ç©ºè°ƒé¢ç§¯è¡¨æ•°æ®
    let currentUser = null; // å½“å‰ç”¨æˆ·ä¿¡æ¯

    // ç©ºè°ƒç±»å‹é€‰é¡¹ï¼ˆåŸºäºæƒå¨æ–‡æ¡£ï¼‰
    const acTypes = [
      'æ²¡æœ‰ç©ºè°ƒ',
      'å…¨ä¸­å¤®ç©ºè°ƒ',
      'VRVç©ºè°ƒï¼ˆå¸ƒç®¡ï¼‰',
      'VRVç©ºè°ƒï¼ˆä¸å¸ƒç®¡ï¼‰',
      'åˆ†ä½“ç©ºè°ƒåŠæ¶ˆé˜²æ’çƒŸ',
      'ä»…æœ‰åˆ†ä½“ç©ºè°ƒ',
      'ä»…æœ‰æ¶ˆé˜²æ’çƒŸ',
      'åœ°ä¸‹å®¤é€šé£åŠæ¶ˆé˜²æ’çƒŸ'
    ];

    if (!token) {
      window.location.href = '/login.html';
    }

    // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
    async function loadCurrentUser() {
      try {
        const response = await fetch(`${API_BASE}/users/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
          const data = await response.json();
          currentUser = data.user;
          
          // æ ¹æ®ç”¨æˆ·è§’è‰²æ˜¾ç¤º/éšè—åˆ›å»ºé¡¹ç›®æŒ‰é’®
          const createBtn = document.getElementById('createProjectBtn');
          if (currentUser.role === 'admin' || currentUser.role === 'finance') {
            createBtn.style.display = 'block';
          }
        }
      } catch (error) {
        console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
      }
    }

    function showMessage(message, type = 'success') {
      const messageEl = document.getElementById('message');
      messageEl.textContent = message;
      messageEl.className = `message ${type} show`;
      setTimeout(() => messageEl.classList.remove('show'), 3000);
    }

    async function loadProjects() {
      try {
        const period = document.getElementById('periodFilter').value;
        const stage = document.getElementById('stageFilter').value;
        
        let url = `${API_BASE}/projects?`;
        if (period) url += `period=${period}&`;
        if (stage) url += `stage=${stage}&`;
        
        const response = await fetch(url, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) throw new Error('åŠ è½½é¡¹ç›®å¤±è´¥');
        
        const data = await response.json();
        projects = data.projects;
        
        // æå–å”¯ä¸€çš„æœŸé—´
        const periods = [...new Set(projects.map(p => p.period).filter(p => p))];
        const periodFilter = document.getElementById('periodFilter');
        periodFilter.innerHTML = '<option value="">å…¨éƒ¨æœŸé—´</option>';
        periods.forEach(period => {
          const option = document.createElement('option');
          option.value = period;
          option.textContent = period;
          periodFilter.appendChild(option);
        });
        
        renderProjects(projects);
      } catch (error) {
        showMessage(error.message, 'error');
        document.getElementById('tableContainer').innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥</div>';
      }
    }

    function renderProjects(data) {
      const container = document.getElementById('tableContainer');
      
      if (data.length === 0) {
        container.innerHTML = '<div class="empty-state"><div style="font-size:48px;margin-bottom:16px;">ğŸ“</div><div>æš‚æ— é¡¹ç›®æ•°æ®</div></div>';
        return;
      }
      
      const stageNames = {
        'scheme': 'æ–¹æ¡ˆè®¾è®¡',
        'construction': 'æ–½å·¥å›¾è®¾è®¡',
        'cooperation': 'åˆä½œé¡¹ç›®'
      };
      
      let html = `
        <table>
          <thead>
            <tr>
              <th>é¡¹ç›®ç¼–å·</th>
              <th>é¡¹ç›®åç§°</th>
              <th>è®¾è®¡é˜¶æ®µ</th>
              <th>å»ºç­‘é¢ç§¯</th>
              <th>æœŸé—´</th>
              <th>è®¡ç®—ææˆ</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      data.forEach(proj => {
        const commission = proj.calculated_commission ? 
          `<span class="commission-badge">Â¥${proj.calculated_commission.toLocaleString()}</span>` : 
          '<span style="color:#999;">æœªè®¡ç®—</span>';
        
        // æ ¹æ®ç”¨æˆ·è§’è‰²å†³å®šæ˜¾ç¤ºå“ªäº›æŒ‰é’®
        const isAdminOrFinance = currentUser && (currentUser.role === 'admin' || currentUser.role === 'finance');
        
        html += `
          <tr>
            <td>${proj.code}</td>
            <td>${proj.name}</td>
            <td>${stageNames[proj.stage] || '-'}</td>
            <td>${proj.building_area ? proj.building_area.toLocaleString() + ' ã¡' : '-'}</td>
            <td>${proj.period || '-'}</td>
            <td>${commission}</td>
            <td>
              <div class="action-buttons">
                <button class="btn btn-primary btn-small" onclick="viewDetail(${proj.id})">æŸ¥çœ‹è¯¦æƒ…</button>
                ${isAdminOrFinance ? `<button class="btn btn-success btn-small" onclick="calculateCommission(${proj.id})">è®¡ç®—ææˆ</button>` : ''}
                ${isAdminOrFinance ? `<button class="btn btn-secondary btn-small" onclick="editProject(${proj.id})">ç¼–è¾‘</button>` : ''}
                ${isAdminOrFinance ? `<button class="btn btn-danger btn-small" onclick="deleteProject(${proj.id}, '${proj.name}')">åˆ é™¤</button>` : ''}
              </div>
            </td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function showAddModal() {
      document.getElementById('modalTitle').textContent = 'åˆ›å»ºé¡¹ç›®';
      document.getElementById('projectForm').reset();
      document.getElementById('projectId').value = '';
      
      // æ¸…ç©ºç©ºè°ƒé¢ç§¯è¡¨
      acTableData = [];
      renderAcTable();
      
      document.getElementById('projectModal').classList.add('show');
    }

    async function editProject(id) {
      const proj = projects.find(p => p.id === id);
      if (!proj) return;
      
      document.getElementById('modalTitle').textContent = 'ç¼–è¾‘é¡¹ç›®';
      document.getElementById('projectId').value = proj.id;
      document.getElementById('code').value = proj.code;
      document.getElementById('name').value = proj.name;
      document.getElementById('stage').value = proj.stage || 'construction';
      document.getElementById('buildingType').value = proj.building_type || 'other';
      document.getElementById('buildingArea').value = proj.building_area || '';
      document.getElementById('period').value = proj.period || '';
      document.getElementById('hasBasement').checked = proj.has_basement === 1;
      document.getElementById('hasCivilDefense').checked = proj.has_civil_defense === 1;
      document.getElementById('isGreenBuilding').checked = proj.is_green_building === 1;
      document.getElementById('isPrefabricated').checked = proj.is_prefabricated === 1;
      document.getElementById('isReportingProject').checked = proj.is_reporting_project === 1;
      document.getElementById('isReviewProject').checked = proj.is_review_project === 1;
      
      // åŠ è½½ç©ºè°ƒé¢ç§¯è¡¨
      try {
        const response = await fetch(`${API_BASE}/air-conditioning/${id}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
          const data = await response.json();
          acTableData = data.tables || [];
        } else {
          acTableData = [];
        }
      } catch (error) {
        console.error('åŠ è½½ç©ºè°ƒé¢ç§¯è¡¨å¤±è´¥:', error);
        acTableData = [];
      }
      
      renderAcTable();
      
      document.getElementById('projectModal').classList.add('show');
    }

    function closeModal() {
      document.getElementById('projectModal').classList.remove('show');
    }

    function closeCommissionModal() {
      document.getElementById('commissionModal').classList.remove('show');
    }

    async function deleteProject(id, name) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤é¡¹ç›®"${name}"å—ï¼Ÿ`)) return;
      
      try {
        const response = await fetch(`${API_BASE}/projects/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) throw new Error('åˆ é™¤å¤±è´¥');
        
        showMessage('é¡¹ç›®åˆ é™¤æˆåŠŸ');
        loadProjects();
      } catch (error) {
        showMessage(error.message, 'error');
      }
    }

    async function calculateCommission(projectId) {
      try {
        const response = await fetch(`${API_BASE}/commission/calculate/${projectId}`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'è®¡ç®—å¤±è´¥');
        }
        
        const data = await response.json();
        displayCommissionResult(data);
        loadProjects(); // åˆ·æ–°åˆ—è¡¨
      } catch (error) {
        showMessage(error.message, 'error');
      }
    }

    function viewDetail(projectId) {
      window.location.href = `/project-detail.html?id=${projectId}`;
    }

    function displayCommissionResult(data) {
      const content = document.getElementById('commissionContent');
      
      let html = `
        <div class="commission-detail">
          <h3 style="margin-bottom: 15px; color: #333;">${data.projectName}</h3>
          <div style="font-size: 32px; font-weight: 600; color: #1890ff; margin-bottom: 20px;">
            æ€»ææˆï¼šÂ¥${data.totalCommission.toLocaleString()}
          </div>
          
          <div class="commission-breakdown">
            <div class="breakdown-item">
              <div class="breakdown-label">è®¾è®¡è´¹ææˆ</div>
              <div class="breakdown-value">Â¥${data.breakdown.designFeeCommission.toLocaleString()}</div>
            </div>
            <div class="breakdown-item">
              <div class="breakdown-label">ç©ºè°ƒé¢ç§¯ææˆ</div>
              <div class="breakdown-value">Â¥${data.breakdown.airConditioningCommission.toLocaleString()}</div>
            </div>
          </div>
          
          <div style="margin-top: 20px; padding: 15px; background: #f0f5ff; border-radius: 6px;">
            <h4 style="margin-bottom: 10px; color: #1890ff;">è®¡ç®—æ˜ç»†</h4>
            <div style="font-size: 13px; color: #666; line-height: 1.8;">
              <div>è®¾è®¡è´¹å•ä»·ï¼šÂ¥${data.breakdown.designFeeUnitPrice}/ã¡</div>
              <div>è®¾è®¡è´¹ææˆæ¯”ä¾‹ï¼š${(data.breakdown.designFeeCommissionRate * 100).toFixed(1)}%</div>
              <div>ç©ºè°ƒé¢ç§¯ï¼š${data.breakdown.airConditioningArea.toLocaleString()} ã¡</div>
              <div>ç©ºè°ƒé¢ç§¯å•ä»·ï¼šÂ¥${data.breakdown.airConditioningUnitPrice}/ã¡</div>
              <div>ç©ºè°ƒé¢ç§¯ææˆæ¯”ä¾‹ï¼š${(data.breakdown.airConditioningCommissionRate * 100).toFixed(1)}%</div>
            </div>
          </div>
        </div>
      `;
      
      content.innerHTML = html;
      document.getElementById('commissionModal').classList.add('show');
    }

    document.getElementById('projectForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const id = document.getElementById('projectId').value;
      const data = {
        code: document.getElementById('code').value,
        name: document.getElementById('name').value,
        stage: document.getElementById('stage').value,
        building_type: document.getElementById('buildingType').value,
        building_area: parseFloat(document.getElementById('buildingArea').value) || null,
        period: document.getElementById('period').value || null,
        has_basement: document.getElementById('hasBasement').checked,
        has_civil_defense: document.getElementById('hasCivilDefense').checked,
        is_green_building: document.getElementById('isGreenBuilding').checked,
        is_prefabricated: document.getElementById('isPrefabricated').checked,
        is_reporting_project: document.getElementById('isReportingProject').checked,
        is_review_project: document.getElementById('isReviewProject').checked
      };
      
      try {
        // éªŒè¯ç©ºè°ƒé¢ç§¯è¡¨æ•°æ®
        for (let i = 0; i < acTableData.length; i++) {
          const row = acTableData[i];
          if (!row.ac_type) {
            alert(`ç©ºè°ƒé¢ç§¯è¡¨ç¬¬ ${i + 1} è¡Œï¼šè¯·é€‰æ‹©ç©ºè°ƒå½¢å¼`);
            return;
          }
          if (!row.area || row.area <= 0) {
            alert(`ç©ºè°ƒé¢ç§¯è¡¨ç¬¬ ${i + 1} è¡Œï¼šè¯·è¾“å…¥æœ‰æ•ˆçš„ç©ºè°ƒé¢ç§¯`);
            return;
          }
        }
        
        const url = id ? `${API_BASE}/projects/${id}` : `${API_BASE}/projects`;
        const method = id ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(data)
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'æ“ä½œå¤±è´¥');
        }
        
        const result = await response.json();
        const projectId = id || result.projectId;
        
        // ä¿å­˜ç©ºè°ƒé¢ç§¯è¡¨ï¼ˆå¦‚æœæœ‰æ•°æ®ï¼‰
        if (acTableData.length > 0) {
          const acResponse = await fetch(`${API_BASE}/air-conditioning/${projectId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ tables: acTableData })
          });
          
          if (!acResponse.ok) {
            console.error('ä¿å­˜ç©ºè°ƒé¢ç§¯è¡¨å¤±è´¥');
            // ä¸é˜»æ­¢é¡¹ç›®ä¿å­˜æˆåŠŸçš„æç¤º
          }
        }
        
        showMessage(id ? 'é¡¹ç›®æ›´æ–°æˆåŠŸ' : 'é¡¹ç›®åˆ›å»ºæˆåŠŸ');
        closeModal();
        loadProjects();
      } catch (error) {
        showMessage(error.message, 'error');
      }
    });

    // ç©ºè°ƒé¢ç§¯è¡¨ç®¡ç†å‡½æ•°
    function renderAcTable() {
      const tbody = document.getElementById('acTableBody');
      
      if (acTableData.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" style="padding: 30px; text-align: center; color: #999; font-size: 13px;">
              æš‚æ— æ•°æ®ï¼Œç‚¹å‡»"+ æ·»åŠ "æŒ‰é’®æ·»åŠ ç©ºè°ƒé¢ç§¯è®°å½•
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = acTableData.map((row, index) => `
        <tr>
          <td style="padding: 8px; border-bottom: 1px solid #f0f0f0;">${index + 1}</td>
          <td style="padding: 8px; border-bottom: 1px solid #f0f0f0;">
            <select class="form-control" style="width: 100%; padding: 6px; border: 1px solid #d9d9d9; border-radius: 4px; font-size: 13px;" 
                    data-index="${index}" data-field="ac_type">
              ${acTypes.map(type => `
                <option value="${type}" ${row.ac_type === type ? 'selected' : ''}>${type}</option>
              `).join('')}
            </select>
          </td>
          <td style="padding: 8px; border-bottom: 1px solid #f0f0f0;">
            <input type="text" class="form-control" style="width: 100%; padding: 6px; border: 1px solid #d9d9d9; border-radius: 4px; font-size: 13px;"
                   value="${row.location || ''}" 
                   data-index="${index}" data-field="location" 
                   placeholder="ä¾‹å¦‚ï¼š1#äº§ä¸šç”¨æˆ¿1~2F" />
          </td>
          <td style="padding: 8px; border-bottom: 1px solid #f0f0f0;">
            <input type="number" class="form-control" style="width: 100%; padding: 6px; border: 1px solid #d9d9d9; border-radius: 4px; font-size: 13px;"
                   value="${row.area || ''}" 
                   data-index="${index}" data-field="area" 
                   placeholder="0" step="0.01" min="0" />
          </td>
          <td style="padding: 8px; border-bottom: 1px solid #f0f0f0;">
            <input type="text" class="form-control" style="width: 100%; padding: 6px; border: 1px solid #d9d9d9; border-radius: 4px; font-size: 13px;"
                   value="${row.notes || ''}" 
                   data-index="${index}" data-field="notes" 
                   placeholder="å¤‡æ³¨" />
          </td>
          <td style="padding: 8px; border-bottom: 1px solid #f0f0f0; text-align: center;">
            <button type="button" class="btn btn-danger btn-small" onclick="deleteAcRow(${index})" 
                    style="padding: 4px 10px; font-size: 12px;">åˆ é™¤</button>
          </td>
        </tr>
      `).join('');

      // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
      tbody.querySelectorAll('input, select').forEach(input => {
        input.addEventListener('change', (e) => {
          const index = parseInt(e.target.dataset.index);
          const field = e.target.dataset.field;
          acTableData[index][field] = e.target.value;
        });
      });
    }

    function addAcRow() {
      acTableData.push({
        ac_type: 'æ²¡æœ‰ç©ºè°ƒ',
        location: '',
        area: 0,
        notes: ''
      });
      renderAcTable();
    }

    function deleteAcRow(index) {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
        acTableData.splice(index, 1);
        renderAcTable();
      }
    }

    // é¡µé¢åˆå§‹åŒ–
    async function initPage() {
      await loadCurrentUser();
      await loadProjects();
    }
    
    initPage();
  </script>
</body>
</html>
