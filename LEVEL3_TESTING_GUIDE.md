# 第三级个人分配功能测试指南

## 功能状态
✅ **已完全实现** - 后端API和前端功能都已完成

## 功能说明
部门经理可以在第三级"个人分配"中选择本部门的员工并输入每个人的提成分配金额。

## 测试步骤

### 前提条件
1. 项目已经计算了第一级提成
2. 项目已经配置了空调面积表并计算了第二级部门分配
3. 使用部门经理账号登录

### 测试流程

#### 1. 登录部门经理账号
```
账号: manager_arch
密码: manager123
```

#### 2. 进入项目详情
1. 点击"项目管理"
2. 找到"韶谷数码城"项目
3. 点击"查看详情"

#### 3. 查看第三级个人分配
在项目详情页向下滚动到"第三级：个人分配"部分，应该看到：

```
┌─────────────────────────────────────────┐
│ 建筑部                                   │
├─────────────────────────────────────────┤
│ 部门总额    已分配      剩余             │
│ ¥72,384    ¥0          ¥72,384          │
├─────────────────────────────────────────┤
│ [分配参与人员] 按钮                      │
└─────────────────────────────────────────┘
```

#### 4. 点击"分配参与人员"按钮
会弹出一个模态框，显示：
- 部门总额、已分配、剩余金额
- 本部门所有员工列表
- 每个员工旁边有金额输入框

#### 5. 输入分配金额
1. 在员工的金额输入框中输入数字（例如：10000）
2. 输入框会自动保存到内存
3. 可以为多个员工输入金额
4. 确保总额不超过部门总额

#### 6. 保存分配
1. 点击模态框底部的"保存"按钮
2. 系统会验证：
   - 金额必须大于0
   - 总额不能超过部门总额
   - 员工必须属于该部门
3. 如果验证通过，显示"个人分配保存成功！"
4. 模态框关闭，页面自动刷新

#### 7. 查看分配结果
保存后，第三级应该显示：

```
┌─────────────────────────────────────────┐
│ 建筑部                                   │
├─────────────────────────────────────────┤
│ 部门总额    已分配      剩余             │
│ ¥72,384    ¥30,000     ¥42,384          │
├─────────────────────────────────────────┤
│ [分配参与人员] 按钮                      │
└─────────────────────────────────────────┘

参与人员
┌──────────┐ ┌──────────┐ ┌──────────┐
│ 张三      │ │ 李四      │ │ 王五      │
│ ¥10,000  │ │ ¥10,000  │ │ ¥10,000  │
│ [删除]   │ │ [删除]   │ │ [删除]   │
└──────────┘ └──────────┘ └──────────┘
```

#### 8. 修改分配
1. 再次点击"分配参与人员"按钮
2. 修改已有员工的金额或添加新员工
3. 点击"保存"

#### 9. 删除分配
1. 在参与人员列表中，点击某个员工的"删除"按钮
2. 确认删除
3. 该员工的分配被删除，剩余金额增加

## 功能特性

### 1. 数据验证
- ✅ 金额必须大于0
- ✅ 总分配不能超过部门总额
- ✅ 只能分配本部门员工
- ✅ 同一员工只能有一条分配记录

### 2. 实时计算
- ✅ 输入金额后自动更新已分配和剩余金额
- ✅ 超额时显示红色警告

### 3. 权限控制
- ✅ 部门经理只能看到和管理本部门的分配
- ✅ 管理员可以查看所有部门的分配（只读）

### 4. 用户体验
- ✅ 已分配的员工背景色变绿
- ✅ 可以随时修改分配金额
- ✅ 删除操作需要确认
- ✅ 保存后自动刷新显示最新数据

## 测试场景

### 场景1：正常分配
```
1. 部门总额：¥72,384
2. 分配3个员工，每人¥20,000
3. 总计：¥60,000
4. 剩余：¥12,384
5. 结果：✅ 保存成功
```

### 场景2：超额分配
```
1. 部门总额：¥72,384
2. 分配4个员工，每人¥20,000
3. 总计：¥80,000
4. 结果：❌ 提示"分配总额超出部门限额，超出金额：¥7,616"
```

### 场景3：修改分配
```
1. 已分配：张三 ¥10,000
2. 修改为：张三 ¥15,000
3. 结果：✅ 更新成功，剩余金额减少¥5,000
```

### 场景4：删除分配
```
1. 已分配：张三 ¥10,000
2. 点击删除按钮
3. 结果：✅ 删除成功，剩余金额增加¥10,000
```

### 场景5：部门经理权限隔离
```
1. 建筑部经理登录
2. 只能看到建筑部的分配
3. 不能看到结构部、电气部等其他部门
4. 结果：✅ 数据隔离正确
```

## 常见问题

### Q1: 点击"分配参与人员"没有反应？
**A**: 检查浏览器控制台是否有错误。可能原因：
- 没有部门员工数据
- API权限问题
- 浏览器缓存问题（尝试硬刷新）

### Q2: 保存时提示"分配总额超出部门限额"？
**A**: 检查：
- 所有输入的金额总和
- 是否超过了部门总额
- 是否有其他员工已经分配但未显示

### Q3: 员工列表为空？
**A**: 可能原因：
- 该部门没有员工
- 员工的department_id不正确
- 需要先在"员工管理"中添加员工

### Q4: 修改后数据没有更新？
**A**: 
- 确认点击了"保存"按钮
- 检查是否有错误提示
- 刷新页面查看最新数据

## API端点

### 获取个人分配
```
GET /api/personal-allocation/:projectId
权限: 认证用户
返回: 分配列表和部门汇总
```

### 保存个人分配
```
POST /api/personal-allocation/:projectId
权限: 管理员或部门经理
请求体: { allocations: [{ employee_id, amount, notes }] }
```

### 删除个人分配
```
DELETE /api/personal-allocation/:projectId/:employeeId
权限: 管理员或部门经理（仅本部门）
```

## 数据库表

使用 `employee_distributions` 表：
```sql
CREATE TABLE employee_distributions (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  project_id INTEGER NOT NULL,
  department_id TEXT NOT NULL,
  employee_id INTEGER NOT NULL,
  amount REAL NOT NULL,
  notes TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(project_id, department_id, employee_id)
);
```

## 相关文件
- `public/project-detail.html` - 前端实现
- `server/routes/personal-allocation.js` - 后端API
- `LEVEL3_COMPLETE_SUMMARY.md` - 功能完成总结
- `LEVEL3_IMPLEMENTATION_STATUS.md` - 实现状态文档

## 总结

第三级个人分配功能已经**完全实现**，包括：
- ✅ 部门经理可以选择员工
- ✅ 可以输入每个员工的分配金额
- ✅ 实时验证和计算
- ✅ 保存、修改、删除功能
- ✅ 权限控制和数据隔离
- ✅ 友好的用户界面

请按照上述步骤测试功能。如果遇到问题，请查看浏览器控制台的错误信息。

---

**文档日期**: 2024年12月14日
